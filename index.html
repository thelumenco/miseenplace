<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Mise en Place</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2352665c' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2c-4 4-6 8-6 12 0 3.31 2.69 6 6 6s6-2.69 6-6c0-4-2-8-6-12z'/%3E%3Cpath d='M12 8v14'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f8f7f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }
    .loading-icon {
      position: relative;
      width: 80px;
      height: 80px;
    }
    .loading-leaf {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      color: #52665c;
    }
    .loading-leaf svg {
      width: 100%;
      height: 100%;
      stroke: currentColor;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
    .loading-spinner {
      position: absolute;
      top: 0;
      left: 0;
      width: 80px;
      height: 80px;
      border: 3px solid #c9d3ce;
      border-top-color: #52665c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 20px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      color: #52665c;
    }
    :root {
      --sage-50: #f4f6f5;
      --sage-100: #e4e9e6;
      --sage-200: #c9d3ce;
      --sage-300: #a3b5ab;
      --sage-400: #7a9185;
      --sage-500: #52665c;
      --sage-600: #42524a;
      --sage-700: #354239;
      --sage-800: #2a332d;
      --sage-900: #1f2622;
      --cream: #fdfcfb;
      --warm-gray: #847e77;
      --charcoal: #3a3632;
      --success: #7dad5e;
      --skip: #c9a87c;
      --energy-low: #c9d3ce;
      --energy-med: #f0e6a3;
      --energy-high: #c9dbe8;
      --font-serif: 'Cormorant Garamond', Georgia, serif;
      --font-sans: 'DM Sans', -apple-system, sans-serif;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --shadow-soft: 0 2px 12px rgba(107, 138, 84, 0.08);
      --shadow-lifted: 0 8px 30px rgba(107, 138, 84, 0.12);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: 16px; }
    body {
      font-family: var(--font-sans);
      background: var(--sage-50);
      color: var(--charcoal);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    .icon {
      width: 24px; height: 24px;
      stroke: currentColor; stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
      fill: none;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: var(--cream);
      position: relative;
    }
    .header {
      padding: 24px 24px 20px;
      background: linear-gradient(to bottom, var(--sage-100) 0%, var(--cream) 100%);
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .logo {
      font-family: var(--font-serif);
      font-size: 1.75rem;
      font-weight: 500;
      color: var(--sage-700);
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-leaf {
      width: 24px;
      height: 24px;
      color: var(--sage-400);
      margin-top: -14px;
    }
    .logo-leaf svg {
      width: 100%;
      height: 100%;
      stroke: currentColor;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
    .header-actions { display: flex; gap: 8px; }
    .icon-btn {
      width: 34px; height: 34px;
      border-radius: 50%;
      border: none;
      background: var(--cream);
      color: var(--sage-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
    }
    .icon-btn .icon { width: 18px; height: 18px; }
    .icon-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-lifted); }
    .icon-btn.active { background: var(--sage-500); color: white; }
    .energy-selector {
      display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;
    }
    .energy-buttons {
      display: flex; gap: 8px;
      padding: 4px; background: white;
      border-radius: var(--radius-md); box-shadow: var(--shadow-soft);
      transition: all 0.3s ease;
    }
    .energy-buttons.hidden {
      display: none;
      padding: 0; margin: -16px 0 0 0;
    }
    .energy-btn {
      flex: 1; padding: 10px 8px; border: none;
      border-radius: var(--radius-sm); background: transparent;
      font-family: var(--font-sans); font-size: 0.75rem;
      color: var(--warm-gray); cursor: pointer;
      transition: all 0.2s ease;
      display: flex; flex-direction: column;
      align-items: center; gap: 4px;
    }
    .energy-btn .energy-bars { 
      width: 24px; 
      height: 20px; 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .energy-btn .energy-bars svg {
      width: 24px;
      height: 20px;
      fill: currentColor;
    }
    .energy-btn.active { background: var(--sage-100); color: var(--sage-700); }
    .equipment-filter {
      background: white;
      border-radius: var(--radius-md);
      padding: 12px;
      box-shadow: var(--shadow-soft);
    }
    .equipment-filter.hidden { display: none; }
    .equipment-filter-label {
      font-size: 0.75rem;
      color: var(--warm-gray);
      margin-bottom: 8px;
    }
    .equipment-filter-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .equipment-filter-item {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      background: white;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.7rem;
      color: var(--sage-600);
    }
    .equipment-filter-item:hover { border-color: var(--sage-400); }
    .equipment-filter-item.selected {
      background: var(--sage-100);
      border-color: var(--sage-500);
      color: var(--sage-700);
    }
    .equipment-filter-item svg {
      width: 16px; height: 16px;
      stroke: currentColor; stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
      fill: none;
    }
    .equipment-filter-clear {
      margin-top: 8px;
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: var(--sage-500);
      font-size: 0.75rem;
      cursor: pointer;
      text-decoration: underline;
    }
    .equipment-filter-clear:hover { color: var(--sage-700); }
    .energy-btn[data-energy="1"].active { background: var(--energy-low); }
    .energy-btn[data-energy="2"].active { background: var(--energy-med); }
    .energy-btn[data-energy="3"].active { background: var(--energy-high); }
    .zone-indicator {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
    }
    .zone-header-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .zone-icon {
      width: 40px;
      height: 40px;
      background: var(--sage-100);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--sage-600);
      flex-shrink: 0;
    }
    .zone-icon svg {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
    .zone-header-text { flex: 1; }
    .zone-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--warm-gray);
      margin-bottom: 4px;
    }
    .zone-name {
      font-family: var(--font-serif);
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--sage-700);
      margin-bottom: 12px;
    }
    .zone-progress { display: flex; align-items: center; gap: 12px; }
    .progress-bar {
      flex: 1; height: 6px;
      background: var(--sage-100);
      border-radius: 3px; overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--sage-400), var(--sage-500));
      border-radius: 3px;
      transition: width 0.4s ease;
    }
    .progress-text {
      font-size: 0.875rem;
      color: var(--sage-600);
      font-weight: 500;
      min-width: 40px;
      text-align: right;
    }
    .timer-float {
      position: sticky; top: 12px; z-index: 100;
      padding: 0 24px;
      margin-bottom: 16px;
    }
    .timer-container {
      display: flex; align-items: center; gap: 16px;
      background: var(--sage-300);
      border-radius: var(--radius-lg);
      padding: 20px 24px;
    }
    .timer-ring { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
    .timer-ring svg { transform: rotate(-90deg); width: 80px; height: 80px; }
    .timer-ring-bg { fill: none; stroke: rgba(255,255,255,0.5); stroke-width: 4; }
    .timer-ring-progress {
      fill: none; stroke: var(--sage-700); stroke-width: 4;
      stroke-linecap: round; transition: stroke-dashoffset 0.5s ease;
    }
    .timer-display {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-family: var(--font-sans);
      font-size: 0.9rem; font-weight: 600;
      color: var(--sage-800);
    }
    .timer-info { flex: 1; }
    .timer-label {
      font-size: 0.7rem; color: var(--sage-800);
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .timer-status {
      font-family: var(--font-serif);
      font-size: 1.25rem;
      color: var(--sage-900);
      font-weight: 600;
    }
    .timer-controls { display: flex; gap: 8px; }
    .timer-btn {
      width: 44px; height: 44px; border-radius: 50%;
      border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
    }
    .timer-btn-primary { background: var(--sage-700); color: white; }
    .timer-btn-primary:hover { background: var(--sage-800); transform: scale(1.05); }
    .timer-btn-secondary { background: rgba(255,255,255,0.7); color: var(--sage-700); }
    .timer-btn-secondary:hover { background: white; }
    .main-content { padding: 0 24px 120px; }
    .main-content .zone-indicator {
      margin: 24px 0 8px;
    }
    .section-header {
      display: flex; justify-content: space-between;
      align-items: center; margin: 24px 0 12px;
    }
    .section-title {
      font-family: var(--font-serif);
      font-size: 1.25rem; font-weight: 600;
      color: var(--sage-800);
    }
    .section-actions { display: flex; align-items: center; gap: 8px; }
    .section-count {
      font-size: 0.75rem; color: var(--warm-gray);
      background: var(--sage-100);
      padding: 4px 10px; border-radius: 12px;
    }
    .time-filter {
      font-size: 0.7rem;
      color: var(--sage-600);
      background: var(--sage-50);
      border: 1px solid var(--sage-200);
      padding: 4px 8px;
      border-radius: 12px;
      cursor: pointer;
      font-family: var(--font-sans);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      padding-right: 20px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2352665c' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 6px center;
    }
    .time-filter:focus {
      border-color: var(--sage-400);
    }
    .edit-section-btn {
      width: 28px; height: 28px; border-radius: 50%;
      border: none; background: transparent;
      color: var(--warm-gray); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .edit-section-btn:hover { background: var(--sage-100); color: var(--sage-600); }
    .task-list { display: flex; flex-direction: column; gap: 8px; }
    .task-item {
      background: white; border-radius: var(--radius-md);
      padding: 16px; display: flex; align-items: center;
      gap: 14px; box-shadow: var(--shadow-soft);
      transition: all 0.2s ease; cursor: pointer;
    }
    .task-item:hover { box-shadow: var(--shadow-lifted); transform: translateY(-1px); }
    .task-item.completed { opacity: 0.6; background: var(--sage-50); }
    .task-item.completed .task-text { text-decoration: line-through; color: var(--warm-gray); }
    .task-item.hidden { display: none; }
    .task-checkbox {
      width: 24px; height: 24px; border-radius: 50%;
      border: 2px solid var(--sage-300);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: all 0.2s ease;
      position: relative;
    }
    .task-checkbox .time-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, calc(-50% - 4px));
      width: 14px; height: 14px;
      color: var(--sage-400);
    }
    .task-checkbox .time-icon svg {
      width: 100%; height: 100%;
      stroke: currentColor; stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
      fill: none;
    }
    .task-item.completed .task-checkbox .time-icon { display: none; }
    .task-item.completed .task-checkbox {
      background: var(--sage-400);
      border-color: var(--sage-400);
      color: white;
    }
    .task-checkbox .icon {
      width: 14px; height: 14px; opacity: 0;
      transform: scale(0.5); transition: all 0.2s ease;
    }
    .task-item.completed .task-checkbox .icon { opacity: 1; transform: scale(1); }
    .task-content { flex: 1; min-width: 0; }
    .task-text { font-size: 0.9375rem; color: var(--charcoal); line-height: 1.4; }
    .task-meta {
      font-size: 0.7rem; color: var(--warm-gray);
      margin-top: 2px; display: flex;
      align-items: center; gap: 6px;
    }
    .task-equipment {
      display: flex; gap: 4px; flex-shrink: 0;
      margin-left: auto; padding-left: 8px;
    }
    .task-equipment-icon {
      width: 22px; height: 22px;
      color: var(--sage-400);
      display: flex; align-items: center; justify-content: center;
    }
    .task-equipment-icon svg {
      width: 18px; height: 18px;
      stroke: currentColor; stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
      fill: none;
    }
    .effort-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .effort-dot.low { background: var(--energy-low); }
    .effort-dot.med { background: var(--energy-med); }
    .effort-dot.high { background: var(--energy-high); }
    /* Streak Garden */
    .garden-section {
      margin: 24px 0;
      padding: 16px;
      background: linear-gradient(180deg, var(--sage-50) 0%, var(--cream) 100%);
      border-radius: var(--radius-md);
      border: 1px solid var(--sage-100);
    }
    .garden-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .garden-title {
      font-family: var(--font-serif);
      font-size: 1rem;
      color: var(--sage-700);
    }
    .garden-streak {
      font-size: 0.75rem;
      color: var(--sage-500);
      background: white;
      padding: 4px 10px;
      border-radius: 12px;
    }
    .garden-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      min-height: 48px;
      align-items: flex-end;
      justify-content: center;
      padding: 8px 0;
    }
    .garden-empty {
      color: var(--sage-400);
      font-size: 0.8rem;
      font-style: italic;
      width: 100%;
      text-align: center;
      padding: 8px;
    }
    .garden-plant {
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: plantGrow 0.5s ease-out;
    }
    .garden-plant svg {
      width: 28px;
      height: 28px;
      stroke: var(--sage-500);
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
    .garden-plant.wilted svg {
      stroke: var(--sage-300);
      opacity: 0.6;
    }
    @keyframes plantGrow {
      0% { transform: scale(0) translateY(10px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    .garden-water {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 10px;
      background: #fef3cd;
      border-radius: var(--radius-sm);
      margin-top: 12px;
      font-size: 0.8rem;
      color: #856404;
    }
    .garden-water-btn {
      padding: 6px 12px;
      background: var(--sage-500);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      cursor: pointer;
    }
    .affirmation {
      text-align: center; padding: 32px 24px 16px;
      color: var(--sage-600); font-style: italic;
      font-family: var(--font-serif); font-size: 1.125rem;
    }
    .app-footer {
      text-align: center;
      font-size: 0.65rem;
      color: var(--sage-300);
      padding: 0 24px 24px;
    }
    /* Focus Mode */
    .focus-overlay {
      position: fixed; inset: 0; background: var(--cream);
      z-index: 200; display: flex; flex-direction: column;
      opacity: 0; visibility: hidden; transition: all 0.3s ease;
    }
    .focus-overlay.active { opacity: 1; visibility: visible; }
    .focus-header {
      padding: 24px; display: flex;
      justify-content: space-between; align-items: center;
    }
    .focus-close {
      width: 44px; height: 44px; border-radius: 50%;
      border: none; background: var(--sage-100);
      color: var(--sage-600); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .focus-content {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 24px; text-align: center;
    }
    .focus-chime-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: var(--sage-400);
      cursor: pointer;
      margin: 0 auto 24px;
      transition: all 0.2s ease;
    }
    .focus-chime-toggle:hover {
      color: var(--sage-600);
    }
    .focus-chime-toggle .icon {
      width: 20px;
      height: 20px;
    }
    .focus-chime-toggle .chime-off {
      display: none;
    }
    .focus-chime-toggle.muted .chime-on {
      display: none;
    }
    .focus-chime-toggle.muted .chime-off {
      display: block;
    }
    .focus-chime-toggle.muted {
      color: var(--sage-300);
    }
    .focus-timer {
      position: relative; width: 200px; height: 200px;
      margin: 0 auto 48px;
      cursor: pointer;
    }
    .focus-timer svg { transform: rotate(-90deg); width: 200px; height: 200px; }
    .focus-timer-bg { fill: none; stroke: var(--sage-100); stroke-width: 8; }
    .focus-timer-progress {
      fill: none; stroke: var(--sage-400); stroke-width: 8;
      stroke-linecap: round; transition: stroke-dashoffset 0.5s ease;
    }
    .focus-timer-display {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-family: var(--font-serif);
      font-size: 3rem; font-weight: 600;
      color: var(--sage-700);
    }
    .focus-task-label {
      font-size: 0.75rem; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--warm-gray);
      margin-bottom: 8px;
    }
    .focus-task-text {
      font-family: var(--font-serif);
      font-size: 1.5rem; color: var(--sage-800);
      margin-bottom: 20px; max-width: 300px;
    }
    .focus-equipment {
      display: flex; flex-wrap: wrap; gap: 8px;
      justify-content: center;
      margin-bottom: 32px;
      max-width: 320px;
    }
    .focus-equipment-item {
      display: flex; align-items: center; gap: 6px;
      background: var(--sage-100);
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      color: var(--sage-700);
    }
    .focus-equipment-item svg {
      width: 18px; height: 18px;
      stroke: currentColor; stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
      fill: none;
    }
    .focus-actions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
    .focus-btn {
      padding: 14px 28px; border-radius: var(--radius-md);
      border: none; font-family: var(--font-sans);
      font-size: 1rem; font-weight: 500;
      cursor: pointer; transition: all 0.2s ease;
    }
    .focus-btn-primary { background: var(--sage-500); color: white; }
    .focus-btn-primary:hover { background: var(--sage-600); }
    .focus-btn-secondary { background: var(--sage-100); color: var(--sage-700); }
    .focus-btn-skip { background: transparent; color: var(--warm-gray); border: 1px solid var(--sage-200); }
    .focus-complete-msg { display: none; }
    .focus-complete-msg.show { display: block; }
    .focus-complete-msg h2 {
      font-family: var(--font-serif);
      font-size: 2rem; color: var(--sage-700);
      margin-bottom: 12px;
    }
    .focus-complete-msg p { color: var(--warm-gray); margin-bottom: 24px; }
    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(56, 71, 46, 0.4);
      backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      padding: 24px; z-index: 1000;
      opacity: 0; visibility: hidden; transition: all 0.3s ease;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--cream); border-radius: var(--radius-lg);
      width: 100%; max-width: 400px; max-height: 85vh;
      overflow-y: auto; transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header {
      padding: 24px 24px 0; display: flex;
      justify-content: space-between; align-items: center;
    }
    .modal-title {
      font-family: var(--font-serif);
      font-size: 1.5rem; font-weight: 600;
      color: var(--sage-800);
    }
    .modal-close {
      width: 36px; height: 36px; border-radius: 50%;
      border: none; background: var(--sage-100);
      color: var(--sage-600); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-body { padding: 24px; }
    .settings-group { margin-bottom: 24px; }
    .settings-label {
      font-size: 0.75rem; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--warm-gray);
      margin-bottom: 8px; display: block;
    }
    .settings-input {
      width: 100%; padding: 12px 16px;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm);
      font-family: var(--font-sans); font-size: 1rem;
      color: var(--charcoal); background: white;
      transition: border-color 0.2s ease;
    }
    .settings-input:focus { outline: none; border-color: var(--sage-400); }
    .timer-presets { display: flex; gap: 8px; }
    .timer-preset {
      flex: 1; padding: 10px;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm); background: white;
      font-family: var(--font-sans); font-size: 0.875rem;
      color: var(--sage-700); cursor: pointer;
      transition: all 0.2s ease;
    }
    .timer-preset.active {
      background: var(--sage-500);
      border-color: var(--sage-500);
      color: white;
    }
    .timer-preset:hover:not(.active) { border-color: var(--sage-400); }
    .chime-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--sage-200);
      transition: 0.3s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--sage-500);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    .toggle-label {
      font-size: 0.85rem;
      color: var(--sage-700);
    }
    .chime-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chime-options.hidden { display: none; }
    .chime-setting {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chime-setting-label {
      font-size: 0.75rem;
      color: var(--warm-gray);
    }
    .chime-sound-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chime-sound-btn {
      padding: 6px 12px;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm);
      background: white;
      font-size: 0.75rem;
      color: var(--sage-600);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .chime-sound-btn:hover { border-color: var(--sage-400); }
    .chime-sound-btn.active {
      background: var(--sage-100);
      border-color: var(--sage-500);
      color: var(--sage-700);
    }
    .chime-interval-options {
      display: flex;
      gap: 6px;
    }
    .chime-interval-btn {
      padding: 6px 12px;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm);
      background: white;
      font-size: 0.75rem;
      color: var(--sage-600);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .chime-interval-btn:hover { border-color: var(--sage-400); }
    .chime-interval-btn.active {
      background: var(--sage-100);
      border-color: var(--sage-500);
      color: var(--sage-700);
    }
    .zone-list { display: flex; flex-direction: column; gap: 8px; }
    .zone-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px; background: white;
      border-radius: var(--radius-sm);
      border: 1.5px solid var(--sage-200);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .zone-item:hover { border-color: var(--sage-300); }
    .zone-item.current { border-color: var(--sage-400); background: var(--sage-50); }
    .zone-item.dragging { opacity: 0.5; transform: scale(1.02); }
    .zone-item-drag {
      color: var(--sage-300); cursor: grab;
      padding: 4px; margin: -4px;
    }
    .zone-item-drag:active { cursor: grabbing; }
    .zone-number {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--sage-200);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: 500; color: var(--sage-700);
    }
    .zone-item.current .zone-number { background: var(--sage-500); color: white; }
    .zone-item-icon {
      width: 32px;
      height: 32px;
      background: var(--sage-100);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--sage-500);
      flex-shrink: 0;
    }
    .zone-item.current .zone-item-icon {
      background: var(--sage-500);
      color: white;
    }
    .zone-item-icon svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
    .zone-item-name { flex: 1; font-size: 0.9375rem; }
    .zone-item-badge {
      font-size: 0.625rem; text-transform: uppercase;
      letter-spacing: 0.05em; color: var(--sage-500);
      background: var(--sage-100);
      padding: 3px 8px; border-radius: 10px;
    }
    .review-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
    .review-stat { background: white; padding: 16px; border-radius: var(--radius-md); text-align: center; }
    .review-stat-value {
      font-family: var(--font-serif);
      font-size: 2rem; font-weight: 600;
      color: var(--sage-700);
    }
    .review-stat-label {
      font-size: 0.75rem; color: var(--warm-gray);
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .review-stat.success .review-stat-value { color: var(--success); }
    .review-tasks { margin-bottom: 24px; }
    .review-tasks-title {
      font-size: 0.75rem; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--warm-gray);
      margin-bottom: 8px;
    }
    .review-task {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 0; border-bottom: 1px solid var(--sage-100);
      font-size: 0.875rem;
    }
    .review-task:last-child { border-bottom: none; }
    .review-task-icon { width: 18px; height: 18px; }
    .review-task-icon.done { color: var(--success); }
    .review-task-icon.skipped { color: var(--skip); }
    /* Calendar */
    .calendar { background: white; border-radius: var(--radius-md); padding: 16px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .calendar-title { font-family: var(--font-serif); font-size: 1.125rem; color: var(--sage-700); }
    .calendar-nav { display: flex; gap: 8px; }
    .calendar-nav-btn {
      width: 32px; height: 32px; border-radius: 50%;
      border: none; background: var(--sage-100);
      color: var(--sage-600); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
    .calendar-weekday {
      text-align: center; font-size: 0.625rem;
      text-transform: uppercase; color: var(--warm-gray);
      padding: 4px;
    }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day {
      aspect-ratio: 1;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; font-size: 0.875rem;
      color: var(--charcoal); cursor: pointer;
      transition: all 0.2s ease; position: relative;
    }
    .calendar-day:hover { background: var(--sage-100); }
    .calendar-day.other-month { color: var(--sage-200); }
    .calendar-day.today { font-weight: 600; color: var(--sage-700); }
    .calendar-day.has-activity::after {
      content: ''; position: absolute; bottom: 2px;
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--sage-400);
    }
    .calendar-day.selected { background: var(--sage-500); color: white; }
    .calendar-day.selected::after { background: white; }
    .day-detail { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--sage-100); }
    .day-detail-title {
      font-size: 0.75rem; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--warm-gray);
      margin-bottom: 8px;
    }
    .day-detail-empty { color: var(--warm-gray); font-size: 0.875rem; font-style: italic; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px; padding: 14px 24px;
      border-radius: var(--radius-md);
      font-family: var(--font-sans); font-size: 1rem;
      font-weight: 500; cursor: pointer;
      transition: all 0.2s ease; border: none; width: 100%;
    }
    .btn-primary { background: var(--sage-500); color: white; }
    .btn-primary:hover { background: var(--sage-600); }
    .btn-secondary { background: var(--sage-100); color: var(--sage-700); }
    .btn-secondary:hover { background: var(--sage-200); }
    .toast {
      position: fixed; bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--sage-800); color: white;
      padding: 14px 24px; border-radius: var(--radius-md);
      font-size: 0.9375rem; opacity: 0; visibility: hidden;
      transition: all 0.3s ease; z-index: 1001;
      text-align: center; max-width: 90%;
    }
    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2000;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 2px;
      opacity: 0;
      animation: confetti-fall 2s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% {
        opacity: 1;
        transform: translateY(-10px) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg);
      }
    }
    .bottom-nav {
      position: fixed; bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 100%; max-width: 480px;
      background: white;
      border-top: 1px solid var(--sage-100);
      padding: 12px 24px 28px;
      display: flex; justify-content: space-around;
      z-index: 50;
    }
    .nav-item {
      display: flex; flex-direction: column;
      align-items: center; gap: 4px;
      color: var(--warm-gray); font-size: 0.625rem;
      text-transform: uppercase; letter-spacing: 0.05em;
      cursor: pointer; background: none; border: none;
      transition: color 0.2s ease;
    }
    .nav-item.active { color: var(--sage-600); }
    .nav-item:hover { color: var(--sage-500); }
    .edit-task-item {
      display: flex; align-items: center; gap: 8px;
      padding: 10px; background: white;
      border-radius: var(--radius-sm); margin-bottom: 6px;
      transition: all 0.2s ease;
    }
    .edit-task-item.dragging {
      opacity: 0.5;
      transform: scale(1.02);
    }
    .edit-task-drag {
      color: var(--sage-300);
      cursor: grab;
      padding: 4px;
      margin: -4px;
      flex-shrink: 0;
    }
    .edit-task-drag:active { cursor: grabbing; }
    .edit-task-input {
      flex: 1; border: none;
      font-family: var(--font-sans); font-size: 0.9375rem;
      color: var(--charcoal); background: transparent;
    }
    .edit-task-input:focus { outline: none; }
    .effort-select {
      padding: 4px 8px;
      border: 1px solid var(--sage-200);
      border-radius: var(--radius-sm);
      font-family: var(--font-sans); font-size: 0.75rem;
      color: var(--sage-700); background: white;
    }
    .delete-task-btn {
      width: 28px; height: 28px; border-radius: 50%;
      border: none; background: transparent;
      color: var(--warm-gray); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .delete-task-btn:hover { background: #fee; color: #c00; }
    .add-task-btn {
      width: 100%; padding: 12px;
      border: 2px dashed var(--sage-200);
      border-radius: var(--radius-sm); background: transparent;
      color: var(--sage-500);
      font-family: var(--font-sans); font-size: 0.875rem;
      cursor: pointer; display: flex;
      align-items: center; justify-content: center;
      gap: 8px; margin-top: 8px;
    }
    .add-task-btn:hover { border-color: var(--sage-400); background: var(--sage-50); }
    
    .equipment-selector {
      display: flex; flex-wrap: wrap; gap: 6px;
      margin-top: 8px; padding-top: 8px;
      border-top: 1px solid var(--sage-100);
    }
    .equipment-toggle {
      width: 36px; height: 36px;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm);
      background: white;
      color: var(--sage-400);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
    }
    .equipment-toggle:hover { border-color: var(--sage-400); }
    .equipment-toggle.selected {
      background: var(--sage-100);
      border-color: var(--sage-500);
      color: var(--sage-700);
    }
    .equipment-toggle svg {
      width: 20px; height: 20px;
      stroke: currentColor; stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
      fill: none;
    }
    .equipment-manager {
      display: flex; flex-wrap: wrap; gap: 8px;
    }
    .equipment-manager-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.8rem;
      color: var(--sage-700);
    }
    .equipment-manager-item:hover { border-color: var(--sage-400); }
    .equipment-manager-item.disabled {
      opacity: 0.4;
      background: var(--sage-50);
    }
    .equipment-manager-item svg {
      width: 18px; height: 18px;
      stroke: currentColor; stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
      fill: none;
    }
    .time-selector {
      display: flex; gap: 4px;
    }
    .time-btn {
      width: 32px; height: 32px;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm);
      background: white;
      color: var(--sage-400);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }
    .time-btn:hover { border-color: var(--sage-400); }
    .time-btn.selected {
      background: var(--sage-100);
      border-color: var(--sage-500);
      color: var(--sage-700);
    }
    .time-btn svg {
      width: 16px; height: 16px;
      stroke: currentColor; stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
      fill: none;
    }
    .zone-icon-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .zone-icon-btn {
      width: 44px;
      height: 44px;
      border: 1.5px solid var(--sage-200);
      border-radius: var(--radius-sm);
      background: white;
      color: var(--sage-400);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      padding: 8px;
    }
    .zone-icon-btn:hover { border-color: var(--sage-400); }
    .zone-icon-btn.selected {
      background: var(--sage-100);
      border-color: var(--sage-500);
      color: var(--sage-700);
    }
    .zone-icon-btn svg {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-icon">
      <div class="loading-spinner"></div>
      <div class="loading-leaf">
        <svg viewBox="0 0 24 24"><path d="M12 2c-4 4-6 8-6 12 0 3.31 2.69 6 6 6s6-2.69 6-6c0-4-2-8-6-12z"/><path d="M12 8v14"/></svg>
      </div>
    </div>
    <div class="loading-text">Mise en Place</div>
  </div>
  <div class="app">
    <div id="mainView">
      <header class="header">
        <div class="header-top">
          <div class="logo">Mise en Place<span class="logo-leaf"><svg viewBox="0 0 24 24"><path d="M12 2c-4 4-6 8-6 12 0 3.31 2.69 6 6 6s6-2.69 6-6c0-4-2-8-6-12z"/><path d="M12 8v14"/></svg></span></div>
          <div class="header-actions">
            <button class="icon-btn" onclick="enterFocusMode()" title="Focus Mode">
              <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
            <button class="icon-btn" onclick="toggleEnergyFilter()" title="Toggle energy filter" id="filterToggle">
              <svg class="icon" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            </button>
            <button class="icon-btn" onclick="openSettings()" title="Settings">
              <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            </button>
          </div>
        </div>
        <div class="energy-selector" id="energySelector">
          <div class="energy-buttons hidden" id="energyButtons">
            <button class="energy-btn" data-energy="1" onclick="setEnergy(1)">
              <span class="energy-bars"><svg viewBox="0 0 24 12"><rect x="4" y="4" width="16" height="4" rx="2"/></svg></span>Low
            </button>
            <button class="energy-btn active" data-energy="2" onclick="setEnergy(2)">
              <span class="energy-bars"><svg viewBox="0 0 24 16"><rect x="4" y="2" width="16" height="4" rx="2"/><rect x="4" y="10" width="16" height="4" rx="2"/></svg></span>Medium
            </button>
            <button class="energy-btn" data-energy="3" onclick="setEnergy(3)">
              <span class="energy-bars"><svg viewBox="0 0 24 20"><rect x="4" y="2" width="16" height="4" rx="2"/><rect x="4" y="8" width="16" height="4" rx="2"/><rect x="4" y="14" width="16" height="4" rx="2"/></svg></span>High
            </button>
          </div>
          <div class="equipment-filter hidden" id="equipmentFilter">
            <div class="equipment-filter-label">Filter by equipment:</div>
            <div class="equipment-filter-list" id="equipmentFilterList"></div>
            <button class="equipment-filter-clear" onclick="clearEquipmentFilter()">Clear equipment filter</button>
          </div>
        </div>
      </header>
      <div class="timer-float">
        <div class="timer-container">
          <div class="timer-ring">
            <svg viewBox="0 0 80 80">
              <circle class="timer-ring-bg" cx="40" cy="40" r="36"/>
              <circle class="timer-ring-progress" id="timerProgress" cx="40" cy="40" r="36" stroke-dasharray="226.19" stroke-dashoffset="0"/>
            </svg>
            <div class="timer-display" id="timerDisplay">20:00</div>
          </div>
          <div class="timer-info">
            <div class="timer-label">Daily Timer</div>
            <div class="timer-status" id="timerStatus">Ready to start</div>
          </div>
          <div class="timer-controls">
            <button class="timer-btn timer-btn-primary" onclick="toggleTimer()">
              <svg class="icon" viewBox="0 0 24 24" id="playIcon"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              <svg class="icon" viewBox="0 0 24 24" id="pauseIcon" style="display:none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            </button>
            <button class="timer-btn timer-btn-secondary" onclick="resetTimer()">
              <svg class="icon" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
          </div>
        </div>
      </div>
      <main class="main-content">
        <div class="section-header">
          <h2 class="section-title">Daily Essentials</h2>
          <div class="section-actions">
            <select class="time-filter" id="dailyTimeFilter" onchange="setDailyTimeFilter(this.value)">
              <option value="all">All</option>
              <option value="morning">‚òÄÔ∏è Morning</option>
              <option value="evening">üåô Evening</option>
              <option value="anytime">Anytime</option>
            </select>
            <span class="section-count" id="dailyCount">0/5</span>
            <button class="edit-section-btn" onclick="openDailyEditor()" title="Edit daily tasks">
              <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
          </div>
        </div>
        <div class="task-list" id="dailyTasks"></div>

        <div class="zone-indicator">
          <div class="zone-header-row">
            <div class="zone-icon" id="currentZoneIcon"></div>
            <div class="zone-header-text">
              <div class="zone-label">Week <span id="weekNumber">1</span> ‚Ä¢ This Week's Zone</div>
              <div class="zone-name" id="currentZoneName">Living Room</div>
            </div>
          </div>
          <div class="zone-progress">
            <div class="progress-bar"><div class="progress-fill" id="zoneProgress" style="width: 0%"></div></div>
            <div class="progress-text" id="zoneProgressText">0%</div>
          </div>
        </div>

        <div class="section-header">
          <h2 class="section-title">Zone Tasks</h2>
          <div class="section-actions">
            <span class="section-count" id="zoneCount">0/7</span>
            <button class="edit-section-btn" onclick="openZoneEditor()" title="Edit zone tasks">
              <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
          </div>
        </div>
        <div class="task-list" id="zoneTasks"></div>

        <div class="garden-section" id="gardenSection">
          <div class="garden-header">
            <span class="garden-title">üå± Your Streak Garden</span>
            <span class="garden-streak" id="gardenStreak">0 days</span>
          </div>
          <div class="garden-container" id="gardenContainer">
            <div class="garden-empty">Complete tasks to grow your garden!</div>
          </div>
          <div class="garden-water" id="gardenWater" style="display:none;">
            <span>üíß Your garden needs water!</span>
            <button class="garden-water-btn" onclick="waterGarden()">Water Garden</button>
          </div>
        </div>

        <div class="affirmation" id="affirmation">Progress, not perfection. You're doing great.</div>
        <footer class="app-footer">Designed by The Lumen Co. All rights reserved. Version 1.8</footer>
      </main>
      <nav class="bottom-nav">
        <button class="nav-item active">
          <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Today
        </button>
        <button class="nav-item" onclick="openZonesManager()">
          <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          Zones
        </button>
        <button class="nav-item" onclick="openHistory()">
          <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          History
        </button>
        <button class="nav-item" onclick="openWeeklyReview()">
          <svg class="icon" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          Review
        </button>
      </nav>
    </div>

    <!-- Focus Mode -->
    <div class="focus-overlay" id="focusOverlay">
      <div class="focus-header">
        <div class="logo">Mise en Place<span class="logo-leaf"><svg viewBox="0 0 24 24"><path d="M12 2c-4 4-6 8-6 12 0 3.31 2.69 6 6 6s6-2.69 6-6c0-4-2-8-6-12z"/><path d="M12 8v14"/></svg></span></div>
        <button class="focus-close" onclick="exitFocusMode()">
          <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="focus-content">
        <div id="focusActiveContent">
          <button class="focus-chime-toggle" id="focusChimeToggle" onclick="toggleFocusChime()" title="Toggle chime">
            <svg class="icon chime-on" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <svg class="icon chime-off" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
          <div class="focus-timer" onclick="toggleTimer()">
            <svg viewBox="0 0 200 200">
              <circle class="focus-timer-bg" cx="100" cy="100" r="90"/>
              <circle class="focus-timer-progress" id="focusTimerProgress" cx="100" cy="100" r="90" stroke-dasharray="565.48" stroke-dashoffset="0"/>
            </svg>
            <div class="focus-timer-display" id="focusTimerDisplay">20:00</div>
          </div>
          <div class="focus-task-label">Current Task</div>
          <div class="focus-task-text" id="focusTaskText">Loading...</div>
          <div class="focus-equipment" id="focusEquipment"></div>
          <div class="focus-actions">
            <button class="focus-btn focus-btn-primary" onclick="completeFocusTask()">Done ‚úì</button>
            <button class="focus-btn focus-btn-skip" onclick="skipFocusTask()">Skip for now</button>
          </div>
        </div>
        <div class="focus-complete-msg" id="focusCompleteMsg">
          <h2>Amazing work! üéâ</h2>
          <p>You've completed your cleaning session.</p>
          <button class="focus-btn focus-btn-primary" onclick="exitFocusMode()">Back to Dashboard</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Settings</h2>
          <button class="modal-close" onclick="closeModal('settingsModal')"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
          <div class="settings-group">
            <label class="settings-label">Timer Duration</label>
            <div class="timer-presets">
              <button class="timer-preset" data-minutes="10" onclick="setTimerPreset(10)">10 min</button>
              <button class="timer-preset active" data-minutes="20" onclick="setTimerPreset(20)">20 min</button>
              <button class="timer-preset" data-minutes="30" onclick="setTimerPreset(30)">30 min</button>
            </div>
          </div>
          <div class="settings-group">
            <label class="settings-label">Mindfulness Chime</label>
            <div class="chime-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="chimeToggle" onchange="toggleChime(this.checked)">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Play gentle chime during timer</span>
            </div>
            <div class="chime-options" id="chimeOptions">
              <div class="chime-setting">
                <span class="chime-setting-label">Sound</span>
                <div class="chime-sound-options" id="chimeSoundOptions"></div>
              </div>
              <div class="chime-setting">
                <span class="chime-setting-label">Every</span>
                <div class="chime-interval-options">
                  <button class="chime-interval-btn" data-interval="1" onclick="setChimeInterval(1)">1 min</button>
                  <button class="chime-interval-btn" data-interval="5" onclick="setChimeInterval(5)">5 min</button>
                  <button class="chime-interval-btn" data-interval="10" onclick="setChimeInterval(10)">10 min</button>
                </div>
              </div>
            </div>
          </div>
          <div class="settings-group">
            <label class="settings-label">Zones Rotation</label>
            <div class="zone-list" id="zoneListSettings"></div>
          </div>
          <div class="settings-group">
            <label class="settings-label">Equipment Icons</label>
            <p style="font-size: 0.75rem; color: var(--warm-gray); margin-bottom: 12px;">Tap to enable/disable equipment options when editing tasks.</p>
            <div class="equipment-manager" id="equipmentManager"></div>
          </div>
          <div class="settings-group">
            <label class="settings-label">Data Management</label>
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
              <button class="btn btn-secondary" onclick="exportData()" style="flex: 1; padding: 12px;">
                <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export
              </button>
              <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="flex: 1; padding: 12px;">
                <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Import
              </button>
              <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
          </div>
          <button class="btn btn-secondary" onclick="resetAllData()" style="margin-top: 8px;">Reset All Data</button>
        </div>
      </div>
    </div>

    <!-- Weekly Review Modal -->
    <div class="modal-overlay" id="reviewModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Weekly Review</h2>
          <button class="modal-close" onclick="closeModal('reviewModal')"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
          <div id="reviewZoneName" style="text-align:center; font-family: var(--font-serif); font-size: 1.25rem; color: var(--sage-700); margin-bottom: 20px;"></div>
          <div class="review-stats">
            <div class="review-stat success"><div class="review-stat-value" id="reviewCompleted">0</div><div class="review-stat-label">Completed</div></div>
            <div class="review-stat"><div class="review-stat-value" id="reviewSkipped">0</div><div class="review-stat-label">Remaining</div></div>
          </div>
          <div class="review-tasks"><div class="review-tasks-title">Completed Tasks</div><div id="reviewCompletedList"></div></div>
          <div class="review-tasks"><div class="review-tasks-title">Didn't Get To</div><div id="reviewSkippedList"></div></div>
          <div style="font-style: italic; text-align: center; color: var(--sage-600); margin: 24px 0; font-family: var(--font-serif);">Let it go ‚Äî there's always next rotation ‚ú®</div>
          <button class="btn btn-primary" onclick="moveToNextZone()">Move to Next Zone ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="historyModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">History</h2>
          <button class="modal-close" onclick="closeModal('historyModal')"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body"><div class="calendar" id="calendar"></div></div>
      </div>
    </div>

    <!-- Daily Tasks Editor -->
    <div class="modal-overlay" id="dailyEditorModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Edit Daily Tasks</h2>
          <button class="modal-close" onclick="closeModal('dailyEditorModal')"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
          <div id="dailyEditorList"></div>
          <button class="add-task-btn" onclick="addDailyTask()">
            <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Task
          </button>
          <button class="btn btn-primary" onclick="saveDailyEdits()" style="margin-top: 16px;">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Zone Tasks Editor -->
    <div class="modal-overlay" id="zoneEditorModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title" id="zoneEditorTitle">Edit Zone Tasks</h2>
          <button class="modal-close" onclick="closeModal('zoneEditorModal')"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
          <div class="settings-group">
            <label class="settings-label">Zone Name</label>
            <input type="text" class="settings-input" id="zoneNameInput">
          </div>
          <div class="settings-group">
            <label class="settings-label">Zone Icon</label>
            <div class="zone-icon-selector" id="zoneIconSelector"></div>
          </div>
          <div class="settings-group">
            <label class="settings-label">Tasks</label>
            <div id="zoneEditorList"></div>
            <button class="add-task-btn" onclick="addZoneTask()">
              <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Task
            </button>
          </div>
          <button class="btn btn-primary" onclick="saveZoneEdits()" style="margin-top: 16px;">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Week Change Modal -->
    <div class="modal-overlay" id="weekChangeModal">
      <div class="modal" style="max-width: 340px;">
        <div class="modal-header">
          <h2 class="modal-title">New Week! üå±</h2>
          <button class="modal-close" onclick="dismissWeekChange()"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body" style="text-align: center;">
          <p style="color: var(--warm-gray); margin-bottom: 8px;">It's a new week! You were working on:</p>
          <p style="font-family: var(--font-serif); font-size: 1.25rem; color: var(--sage-800); margin-bottom: 24px;" id="weekChangeZoneName">Living Room</p>
          <p style="color: var(--warm-gray); margin-bottom: 24px; font-size: 0.9rem;">Would you like to review your progress before moving to the next zone?</p>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-primary" onclick="goToWeeklyReview()">Review Progress</button>
            <button class="btn btn-secondary" onclick="confirmWeekChange()">Skip to Next Zone</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Zone Confirmation Modal -->
    <div class="modal-overlay" id="deleteZoneConfirmModal" style="z-index: 1100;">
      <div class="modal" style="max-width: 320px;">
        <div class="modal-header">
          <h2 class="modal-title">Delete Zone?</h2>
          <button class="modal-close" onclick="closeModal('deleteZoneConfirmModal')"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
          <p style="color: var(--warm-gray); margin-bottom: 24px;">Are you sure you want to delete "<span id="deleteZoneName"></span>"? This action cannot be undone.</p>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="closeModal('deleteZoneConfirmModal')" style="flex: 1;">Cancel</button>
            <button class="btn btn-primary" onclick="confirmDeleteZone()" style="flex: 1;">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal-overlay" id="resetConfirmModal">
      <div class="modal" style="max-width: 320px;">
        <div class="modal-header">
          <h2 class="modal-title">Reset All Data?</h2>
          <button class="modal-close" onclick="closeModal('resetConfirmModal')"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
          <p style="color: var(--warm-gray); margin-bottom: 24px;">This will permanently delete all your zones, tasks, and progress. This action cannot be undone.</p>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="closeModal('resetConfirmModal')" style="flex: 1;">Cancel</button>
            <button class="btn" onclick="confirmReset()" style="flex: 1; background: #c44; color: white;">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Zones Manager Modal -->
    <div class="modal-overlay" id="zonesManagerModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Manage Zones</h2>
          <button class="modal-close" onclick="closeModal('zonesManagerModal')"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
          <p style="font-size: 0.875rem; color: var(--warm-gray); margin-bottom: 16px;">Drag to reorder. Tap a zone to edit its tasks.</p>
          <div class="zone-list" id="zonesManagerList"></div>
          <button class="add-task-btn" onclick="addNewZone()" style="margin-top: 16px;">
            <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add New Zone
          </button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    const DEFAULT_ZONES = [
      { id: 1, name: "Living Room & Balcony", icon: 'living', tasks: [
        { text: "Wipe TV console and surfaces", effort: 1, equipment: ['cloth', 'duster'] },
        { text: "Vacuum/mop floor", effort: 2, equipment: ['vacuum', 'mop'] },
        { text: "Clean window grilles", effort: 3, equipment: ['spray', 'cloth', 'brush'] },
        { text: "Dust ceiling fan", effort: 2, equipment: ['duster'] },
        { text: "Wipe down sofa", effort: 2, equipment: ['vacuum', 'cloth'] },
        { text: "Tidy balcony plants", effort: 1, equipment: [] },
        { text: "Clean balcony floor", effort: 2, equipment: ['broom', 'mop', 'bucket'] }
      ]},
      { id: 2, name: "Kitchen", icon: 'kitchen', tasks: [
        { text: "Deep clean stove & hood", effort: 3, equipment: ['spray', 'sponge', 'gloves', 'brush'] },
        { text: "Wipe down cabinets", effort: 2, equipment: ['spray', 'cloth'] },
        { text: "Clean inside fridge", effort: 3, equipment: ['spray', 'cloth', 'sponge'] },
        { text: "Scrub sink thoroughly", effort: 2, equipment: ['spray', 'sponge', 'brush'] },
        { text: "Wipe appliances", effort: 1, equipment: ['spray', 'cloth'] },
        { text: "Clean floor & drain", effort: 2, equipment: ['mop', 'bucket', 'brush'] },
        { text: "Organize dry goods", effort: 1, equipment: [] }
      ]},
      { id: 3, name: "Master Bedroom", icon: 'master', tasks: [
        { text: "Change bed linens", effort: 2, equipment: ['laundry'] },
        { text: "Vacuum mattress", effort: 2, equipment: ['vacuum'] },
        { text: "Clean wardrobe surfaces", effort: 1, equipment: ['cloth', 'duster'] },
        { text: "Wipe window sills", effort: 1, equipment: ['spray', 'cloth'] },
        { text: "Dust bedside tables", effort: 1, equipment: ['duster', 'cloth'] },
        { text: "Organize dresser", effort: 2, equipment: [] },
        { text: "Mop floor under bed", effort: 3, equipment: ['mop', 'bucket', 'vacuum'] }
      ]},
      { id: 4, name: "Common Bedroom", icon: 'bedroom', tasks: [
        { text: "Change bed linens", effort: 2, equipment: ['laundry'] },
        { text: "Vacuum under furniture", effort: 2, equipment: ['vacuum'] },
        { text: "Wipe desk & shelves", effort: 1, equipment: ['spray', 'cloth', 'duster'] },
        { text: "Organize storage", effort: 2, equipment: [] },
        { text: "Clean window grilles", effort: 2, equipment: ['spray', 'cloth', 'brush'] },
        { text: "Dust surfaces", effort: 1, equipment: ['duster'] },
        { text: "Mop floor", effort: 2, equipment: ['mop', 'bucket'] }
      ]},
      { id: 5, name: "Bathrooms", icon: 'bathroom', tasks: [
        { text: "Scrub toilet bowl", effort: 2, equipment: ['brush', 'spray', 'gloves'] },
        { text: "Clean shower area", effort: 2, equipment: ['spray', 'sponge', 'squeegee'] },
        { text: "Wipe mirror & basin", effort: 1, equipment: ['spray', 'cloth'] },
        { text: "Descale taps & showerhead", effort: 3, equipment: ['spray', 'brush', 'cloth', 'gloves'] },
        { text: "Clean floor & drain", effort: 2, equipment: ['brush', 'mop', 'bucket'] },
        { text: "Wash bathroom mats", effort: 2, equipment: ['laundry'] },
        { text: "Wipe cabinet surfaces", effort: 1, equipment: ['spray', 'cloth'] }
      ]}
    ];
    const DEFAULT_DAILY = [
      { id: 'd1', text: "Clear dining table", effort: 1, equipment: [], timeOfDay: null },
      { id: 'd2', text: "Wipe dining table", effort: 1, equipment: ['spray', 'cloth'], timeOfDay: 'evening' },
      { id: 'd3', text: "Wipe high chair", effort: 1, equipment: ['spray', 'cloth'], timeOfDay: 'evening' },
      { id: 'd4', text: "Pick up toys", effort: 2, equipment: [], timeOfDay: 'evening' },
      { id: 'd5', text: "Prep bag for next day", effort: 2, equipment: [], timeOfDay: 'evening' },
      { id: 'd6', text: "Load laundry", effort: 1, equipment: ['laundry'], timeOfDay: 'morning' }
    ];
    const EFFORT_LABELS = { 1: 'Low effort', 2: 'Medium effort', 3: 'High effort' };
    
    const EQUIPMENT = {
      spray: { name: 'Cleaning spray', icon: '<svg viewBox="0 0 24 24"><rect x="6" y="10" width="10" height="12" rx="2"/><path d="M8 10V8a3 3 0 0 1 6 0v2"/><path d="M14 6h4l-2-4"/><path d="M16 4l2 1"/><path d="M11 10V7"/></svg>' },
      cloth: { name: 'Cloth/Rag', icon: '<svg viewBox="0 0 24 24"><path d="M6 4h8l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/><path d="M14 4v4h4"/></svg>' },
      broom: { name: 'Broom', icon: '<svg viewBox="0 0 24 24"><path d="M12 2v8"/><path d="M4 22l4-12h8l4 12"/><path d="M7 14h10"/></svg>' },
      mop: { name: 'Mop', icon: '<svg viewBox="0 0 24 24"><path d="M12 2v10"/><rect x="8" y="12" width="8" height="3" rx="1"/><path d="M6 15v7"/><path d="M10 15v7"/><path d="M14 15v7"/><path d="M18 15v7"/></svg>' },
      vacuum: { name: 'Vacuum', icon: '<svg viewBox="0 0 24 24"><circle cx="8" cy="18" r="3"/><path d="M11 18h6a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-3"/><path d="M14 6l-4 6"/><path d="M8 15V6a2 2 0 0 1 2-2h1"/></svg>' },
      bucket: { name: 'Bucket', icon: '<svg viewBox="0 0 24 24"><path d="M5 8h14l-2 12H7L5 8z"/><path d="M4 8a8 8 0 0 1 16 0"/><path d="M9 8v2"/><path d="M15 8v2"/></svg>' },
      sponge: { name: 'Sponge', icon: '<svg viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="10" rx="2"/><circle cx="8" cy="13" r="1"/><circle cx="12" cy="11" r="1"/><circle cx="16" cy="14" r="1"/><circle cx="10" cy="15" r="1"/><circle cx="14" cy="13" r="1"/></svg>' },
      gloves: { name: 'Gloves', icon: '<svg viewBox="0 0 24 24"><path d="M6 10V5a2 2 0 0 1 4 0v3"/><path d="M10 8V4a2 2 0 0 1 4 0v4"/><path d="M14 8V5a2 2 0 0 1 4 0v5"/><path d="M6 10a4 4 0 0 0 0 8h12a4 4 0 0 0 0-8"/><path d="M6 18v2"/><path d="M18 18v2"/></svg>' },
      duster: { name: 'Duster', icon: '<svg viewBox="0 0 24 24"><path d="M4 20l8-8"/><circle cx="14" cy="10" r="6"/><path d="M11 7c1-1 3-1 4 0s1 3 0 4"/></svg>' },
      iron: { name: 'Iron', icon: '<svg viewBox="0 0 24 24"><path d="M3 18h18v-4L12 8H4a2 2 0 0 0-2 2v6a2 2 0 0 0 1 2z"/><path d="M21 14l-9-6"/><path d="M7 18v2"/><path d="M17 18v2"/></svg>' },
      brush: { name: 'Scrub brush', icon: '<svg viewBox="0 0 24 24"><rect x="6" y="4" width="12" height="8" rx="2"/><path d="M8 12v6"/><path d="M12 12v6"/><path d="M16 12v6"/><path d="M6 8h12"/></svg>' },
      squeegee: { name: 'Squeegee', icon: '<svg viewBox="0 0 24 24"><path d="M4 6h16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"/><path d="M12 12v8"/></svg>' },
      bin: { name: 'Trash bag', icon: '<svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14"/></svg>' },
      laundry: { name: 'Laundry basket', icon: '<svg viewBox="0 0 24 24"><path d="M4 6l2 14h12l2-14"/><path d="M2 6h20"/><path d="M8 6V4"/><path d="M16 6V4"/><path d="M9 11c1 2 5 2 6 0"/></svg>' },
      stool: { name: 'Step stool', icon: '<svg viewBox="0 0 24 24"><rect x="5" y="4" width="14" height="4" rx="1"/><path d="M7 8v12"/><path d="M17 8v12"/><path d="M7 14h10"/></svg>' },
      wipes: { name: 'Wet wipes', icon: '<svg viewBox="0 0 24 24"><path d="M12 2c-4 4-6 8-6 12a6 6 0 0 0 12 0c0-4-2-8-6-12z"/></svg>' },
      paper: { name: 'Paper towels', icon: '<svg viewBox="0 0 24 24"><path d="M12 3c-4 0-7 1-7 3v12c0 2 3 3 7 3s7-1 7-3V6c0-2-3-3-7-3z"/><ellipse cx="12" cy="6" rx="7" ry="3"/><path d="M5 12c0 2 3 3 7 3s7-1 7-3"/></svg>' }
    };

    // Garden plants - grows with streak
    const GARDEN_PLANTS = [
      { name: 'Sprout', icon: '<svg viewBox="0 0 24 24"><path d="M12 22v-8"/><path d="M9 14c-3-3 0-7 3-6"/><path d="M15 14c3-3 0-7-3-6"/></svg>' },
      { name: 'Seedling', icon: '<svg viewBox="0 0 24 24"><path d="M12 22v-10"/><path d="M8 16c-4-2-2-8 4-6"/><path d="M16 16c4-2 2-8-4-6"/><path d="M12 12c0-4 3-6 5-4"/></svg>' },
      { name: 'Small Flower', icon: '<svg viewBox="0 0 24 24"><path d="M12 22v-10"/><circle cx="12" cy="8" r="3"/><circle cx="12" cy="5" r="2"/><circle cx="9" cy="7" r="2"/><circle cx="15" cy="7" r="2"/><circle cx="10" cy="10" r="2"/><circle cx="14" cy="10" r="2"/></svg>' },
      { name: 'Tulip', icon: '<svg viewBox="0 0 24 24"><path d="M12 22v-12"/><path d="M9 18c-2 0-3-1-3-2"/><path d="M15 18c2 0 3-1 3-2"/><path d="M12 10c-3 0-5-3-5-6 2 0 5 2 5 6 0-4 3-6 5-6 0 3-2 6-5 6z"/></svg>' },
      { name: 'Daisy', icon: '<svg viewBox="0 0 24 24"><path d="M12 22v-10"/><path d="M8 18l-2 2"/><path d="M16 18l2 2"/><circle cx="12" cy="8" r="2"/><ellipse cx="12" cy="4" rx="2" ry="3"/><ellipse cx="8" cy="6" rx="2" ry="3" transform="rotate(-45 8 6)"/><ellipse cx="16" cy="6" rx="2" ry="3" transform="rotate(45 16 6)"/><ellipse cx="8" cy="10" rx="2" ry="3" transform="rotate(45 8 10)"/><ellipse cx="16" cy="10" rx="2" ry="3" transform="rotate(-45 16 10)"/></svg>' },
      { name: 'Rose', icon: '<svg viewBox="0 0 24 24"><path d="M12 22v-8"/><path d="M8 20c-3 0-4-2-4-3"/><path d="M16 20c3 0 4-2 4-3"/><circle cx="12" cy="9" r="5"/><path d="M12 4c-2 0-3 2-3 4"/><path d="M12 4c2 0 3 2 3 4"/><path d="M9 8c0-2 1-3 3-3s3 1 3 3"/></svg>' },
      { name: 'Sunflower', icon: '<svg viewBox="0 0 24 24"><path d="M12 22v-8"/><path d="M7 18l-3 2"/><path d="M17 18l3 2"/><circle cx="12" cy="8" r="3"/><path d="M12 2v3"/><path d="M17 4l-2 2"/><path d="M7 4l2 2"/><path d="M19 8h-3"/><path d="M8 8H5"/><path d="M17 12l2 2"/><path d="M7 12l-2 2"/></svg>' },
      { name: 'Lavender', icon: '<svg viewBox="0 0 24 24"><path d="M12 22v-14"/><path d="M10 20c-2 0-3-1-2-2"/><path d="M14 20c2 0 3-1 2-2"/><ellipse cx="12" cy="6" rx="2" ry="1"/><ellipse cx="11" cy="8" rx="2" ry="1"/><ellipse cx="13" cy="8" rx="2" ry="1"/><ellipse cx="12" cy="10" rx="2" ry="1"/><ellipse cx="11" cy="4" rx="1.5" ry="1"/><ellipse cx="13" cy="4" rx="1.5" ry="1"/><ellipse cx="12" cy="3" rx="1" ry="1"/></svg>' }
    ];

    function getPlantForDay(dayIndex) {
      // Cycle through plants, with some variation
      return GARDEN_PLANTS[dayIndex % GARDEN_PLANTS.length];
    }

    const ZONE_ICONS = {
      living: { name: 'Living Room', icon: '<svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="12" rx="2"/><rect x="4" y="9" width="16" height="8" rx="1"/><path d="M8 19v2"/><path d="M16 19v2"/></svg>' },
      kitchen: { name: 'Kitchen', icon: '<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="4" y1="10" x2="20" y2="10"/><circle cx="8" cy="7" r="1"/><circle cx="12" cy="7" r="1"/><path d="M8 14h8"/><path d="M8 17h5"/></svg>' },
      master: { name: 'Master Bedroom', icon: '<svg viewBox="0 0 24 24"><path d="M3 18v-5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v5"/><path d="M3 18h18"/><path d="M5 11V8a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v3"/><path d="M3 18v2"/><path d="M21 18v2"/></svg>' },
      kids: { name: 'Kids Bedroom', icon: '<svg viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="12" rx="1"/><path d="M4 10h16"/><path d="M6 6V4"/><path d="M18 6V4"/><path d="M6 18v2"/><path d="M18 18v2"/><path d="M9 10v8"/><path d="M15 10v8"/></svg>' },
      bathroom: { name: 'Bathroom', icon: '<svg viewBox="0 0 24 24"><path d="M4 12h16v5a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-5z"/><path d="M6 12V5a2 2 0 0 1 2-2h1"/><circle cx="18" cy="6" r="2"/><path d="M6 20v2"/><path d="M18 20v2"/></svg>' },
      balcony: { name: 'Balcony', icon: '<svg viewBox="0 0 24 24"><rect x="3" y="10" width="18" height="2"/><path d="M5 12v8"/><path d="M19 12v8"/><path d="M3 20h18"/><path d="M8 10V4"/><path d="M16 10V4"/><path d="M12 10V6"/><circle cx="12" cy="4" r="2"/></svg>' },
      service: { name: 'Service Yard', icon: '<svg viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M4 12h16"/><circle cx="8" cy="15" r="2"/><circle cx="16" cy="15" r="2"/><path d="M8 8V6"/><path d="M16 8V6"/></svg>' },
      store: { name: 'Store Room', icon: '<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 10h16"/><path d="M4 16h16"/><path d="M10 4v16"/></svg>' },
      dining: { name: 'Dining Room', icon: '<svg viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="9" ry="5"/><path d="M12 7v-4"/><path d="M8 8V5"/><path d="M16 8V5"/><path d="M6 17v3"/><path d="M18 17v3"/></svg>' },
      study: { name: 'Study', icon: '<svg viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="10" rx="1"/><path d="M8 8V6"/><path d="M16 8V6"/><rect x="7" y="11" width="4" height="3"/><path d="M14 11h3"/><path d="M14 13h2"/></svg>' },
      garage: { name: 'Garage', icon: '<svg viewBox="0 0 24 24"><path d="M4 10l8-6 8 6v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V10z"/><rect x="7" y="14" width="10" height="7"/><path d="M7 17h10"/></svg>' },
      laundry: { name: 'Laundry', icon: '<svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><circle cx="12" cy="13" r="5"/><circle cx="12" cy="13" r="2"/><circle cx="8" cy="5" r="1"/><circle cx="12" cy="5" r="1"/></svg>' },
      teddy: { name: 'Playroom', icon: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="6"/><circle cx="8" cy="6" r="3"/><circle cx="16" cy="6" r="3"/><circle cx="10" cy="11" r="1"/><circle cx="14" cy="11" r="1"/><ellipse cx="12" cy="14" rx="2" ry="1"/></svg>' },
      book: { name: 'Library', icon: '<svg viewBox="0 0 24 24"><path d="M4 19V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v14"/><path d="M4 19h16"/><path d="M12 3v13"/><path d="M4 8h8"/><path d="M12 8h8"/></svg>' },
      shoe: { name: 'Entryway', icon: '<svg viewBox="0 0 24 24"><path d="M4 16c0 2 1 3 3 3h10c2 0 3-1 3-2v-3H4v2z"/><path d="M4 14l3-6c1-2 3-3 5-3s4 1 5 3l3 6"/><path d="M8 19v2"/><path d="M16 19v2"/></svg>' },
      dumbbell: { name: 'Gym', icon: '<svg viewBox="0 0 24 24"><path d="M6 7v10"/><path d="M18 7v10"/><path d="M4 9v6"/><path d="M20 9v6"/><path d="M6 12h12"/><rect x="2" y="10" width="2" height="4" rx="0.5"/><rect x="20" y="10" width="2" height="4" rx="0.5"/></svg>' },
      paintbrush: { name: 'Art Room', icon: '<svg viewBox="0 0 24 24"><path d="M18 2l-8 8-4 1 1-4 8-8 3 3z"/><path d="M7 11l-3 3c-1 1-1 3 0 4s3 1 4 0l3-3"/><path d="M5 18c0 1 1 2 2 2"/></svg>' }
    };
    const AFFIRMATIONS = [
      "Progress, not perfection. You're doing great.",
      "A clean home doesn't happen overnight. Be patient.",
      "Every small step counts. You've got this.",
      "15 minutes can make a real difference.",
      "Done is better than perfect.",
      "You deserve a peaceful space."
    ];

    // Audio context for chime sounds
    let audioContext = null;
    
    function getAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }

    const CHIME_SOUNDS = {
      bowl: { name: 'Singing Bowl', freq: 220, type: 'sine', decay: 3 },
      bell: { name: 'Soft Bell', freq: 440, type: 'sine', decay: 2 },
      chime: { name: 'Wind Chime', freq: 880, type: 'triangle', decay: 1.5 },
      gong: { name: 'Gentle Gong', freq: 110, type: 'sine', decay: 4 },
      tone: { name: 'Pure Tone', freq: 528, type: 'sine', decay: 2.5 }
    };

    function playChime(soundKey) {
      try {
        const ctx = getAudioContext();
        const sound = CHIME_SOUNDS[soundKey] || CHIME_SOUNDS.bowl;
        
        if (soundKey === 'chime') {
          // Wind chime - multiple overlapping tones at different times
          const chimeFreqs = [1200, 1400, 1000, 1600, 1100];
          const delays = [0, 0.1, 0.2, 0.35, 0.5];
          
          chimeFreqs.forEach((freq, i) => {
            setTimeout(() => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              
              osc.type = 'sine';
              // Slight randomness in frequency for natural feel
              osc.frequency.setValueAtTime(freq * (0.98 + Math.random() * 0.04), ctx.currentTime);
              
              gain.gain.setValueAtTime(0.15, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1.5);
              
              osc.connect(gain);
              gain.connect(ctx.destination);
              
              osc.start(ctx.currentTime);
              osc.stop(ctx.currentTime + 1.5);
            }, delays[i] * 1000);
          });
          return;
        }
        
        // Create oscillator
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.type = sound.type;
        osc.frequency.setValueAtTime(sound.freq, ctx.currentTime);
        
        // Add slight frequency variation for richness
        osc.frequency.exponentialRampToValueAtTime(sound.freq * 0.98, ctx.currentTime + sound.decay);
        
        // Create envelope
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + sound.decay);
        
        // Add harmonics for singing bowl effect
        if (soundKey === 'bowl' || soundKey === 'gong') {
          const osc2 = ctx.createOscillator();
          const gain2 = ctx.createGain();
          osc2.type = 'sine';
          osc2.frequency.setValueAtTime(sound.freq * 2.5, ctx.currentTime);
          gain2.gain.setValueAtTime(0.1, ctx.currentTime);
          gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + sound.decay * 0.7);
          osc2.connect(gain2);
          gain2.connect(ctx.destination);
          osc2.start(ctx.currentTime);
          osc2.stop(ctx.currentTime + sound.decay);
        }
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + sound.decay);
      } catch(e) {
        console.log('Audio not supported');
      }
    }

    let state = {
      zones: [], dailyTasks: [], currentZoneIndex: 0,
      weekStartDate: null, timerMinutes: 20, timerSeconds: 0,
      timerRunning: false, timerInterval: null, streak: 0,
      lastActiveDate: null, dailyLog: {}, zoneLog: {}, energyLevel: 2,
      garden: [], gardenNeedsWater: false,
      dailyTimeFilter: 'all',
      filterVisible: false, filterActive: false,
      calendarMonth: new Date().getMonth(), calendarYear: new Date().getFullYear(),
      selectedDate: null, focusTasks: [], focusIndex: 0,
      enabledEquipment: ['spray', 'cloth', 'broom', 'mop', 'vacuum', 'bucket', 'sponge', 'gloves', 'duster', 'iron', 'brush', 'squeegee', 'bin', 'laundry', 'stool', 'wipes', 'paper'],
      weekChangePending: false,
      equipmentFilter: [],
      chimeEnabled: true,
      chimeSound: 'bowl',
      chimeInterval: 5
    };

    function init() {
      try {
        loadState();
        checkStreak();
        renderAll();
        document.getElementById('affirmation').textContent = AFFIRMATIONS[Math.floor(Math.random() * AFFIRMATIONS.length)];
      } catch(e) {
        console.error('Init error:', e);
      }
      // Hide loading screen
      document.getElementById('loadingScreen').classList.add('hidden');
    }

    function loadState() {
      const saved = localStorage.getItem('miseEnPlaceState');
      if (saved) {
        const p = JSON.parse(saved);
        state = { ...state, ...p };
        // Ensure enabledEquipment exists for older saved states
        if (!state.enabledEquipment) state.enabledEquipment = Object.keys(EQUIPMENT);
        state.timerSeconds = state.timerMinutes * 60;
        state.timerRunning = false;
      } else {
        state.zones = JSON.parse(JSON.stringify(DEFAULT_ZONES));
        state.dailyTasks = JSON.parse(JSON.stringify(DEFAULT_DAILY));
        state.weekStartDate = getWeekStart();
        state.timerSeconds = state.timerMinutes * 60;
        saveState();
      }
    }

    function saveState() {
      const s = { ...state };
      delete s.timerInterval; delete s.timerRunning;
      localStorage.setItem('miseEnPlaceState', JSON.stringify(s));
    }

    function getWeekStart() {
      const d = new Date(); d.setDate(d.getDate() - d.getDay());
      return d.toISOString().split('T')[0];
    }

    function checkWeekChange() {
      const currentWeekStart = getWeekStart();
      if (state.weekStartDate && state.weekStartDate !== currentWeekStart && !state.weekChangePending) {
        // Week has changed, mark as pending and show review modal
        state.weekChangePending = true;
        saveState();
        showWeekChangeModal();
      } else if (!state.weekStartDate) {
        state.weekStartDate = currentWeekStart;
        saveState();
      }
    }

    function showWeekChangeModal() {
      const z = state.zones[state.currentZoneIndex];
      document.getElementById('weekChangeZoneName').textContent = z.name;
      document.getElementById('weekChangeModal').classList.add('active');
    }

    function dismissWeekChange() {
      closeModal('weekChangeModal');
    }

    function confirmWeekChange() {
      closeModal('weekChangeModal');
      // Advance to next zone
      state.currentZoneIndex = (state.currentZoneIndex + 1) % state.zones.length;
      state.weekStartDate = getWeekStart();
      state.weekChangePending = false;
      saveState();
      renderAll();
      showToast(`Now on: ${state.zones[state.currentZoneIndex].name}`);
    }

    function goToWeeklyReview() {
      closeModal('weekChangeModal');
      openWeeklyReview();
    }

    function getTodayKey() { return new Date().toISOString().split('T')[0]; }

    function checkStreak() {
      const today = getTodayKey();
      const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
      const yKey = yesterday.toISOString().split('T')[0];
      if (state.lastActiveDate && state.lastActiveDate !== today && state.lastActiveDate !== yKey) {
        // Missed a day - garden needs water instead of losing everything
        state.gardenNeedsWater = true;
        state.streak = 0; 
        saveState();
      }
    }

    function renderAll() {
      checkWeekChange();
      renderZoneHeader(); renderDailyTasks(); renderZoneTasks();
      renderTimer(); updateProgress(); updateStreak(); updateEnergyUI();
      updateFilterUI();
    }

    function renderZoneHeader() {
      const z = state.zones[state.currentZoneIndex];
      document.getElementById('currentZoneName').textContent = z.name;
      document.getElementById('weekNumber').textContent = state.currentZoneIndex + 1;
      const iconData = ZONE_ICONS[z.icon] || ZONE_ICONS.living;
      document.getElementById('currentZoneIcon').innerHTML = iconData.icon;
    }

    function setEnergy(level) {
      state.energyLevel = level; saveState();
      updateEnergyUI(); renderDailyTasks(); renderZoneTasks();
    }

    function toggleEnergyFilter() {
      state.filterVisible = !state.filterVisible;
      saveState();
      updateFilterUI();
    }

    function updateFilterUI() {
      const toggle = document.getElementById('filterToggle');
      const buttons = document.getElementById('energyButtons');
      const equipFilter = document.getElementById('equipmentFilter');
      // Button is active if any filter is applied
      const hasActiveFilter = state.filterActive || (state.equipmentFilter && state.equipmentFilter.length > 0);
      toggle.classList.toggle('active', hasActiveFilter);
      // Show/hide based on visibility state
      buttons.classList.toggle('hidden', !state.filterVisible);
      equipFilter.classList.toggle('hidden', !state.filterVisible);
      if (state.filterVisible) {
        renderEquipmentFilterList();
      }
    }

    function renderEquipmentFilterList() {
      const container = document.getElementById('equipmentFilterList');
      const enabledItems = Object.entries(EQUIPMENT).filter(([key]) => state.enabledEquipment.includes(key));
      container.innerHTML = enabledItems.map(([key, eq]) => `
        <div class="equipment-filter-item ${state.equipmentFilter.includes(key) ? 'selected' : ''}" 
             onclick="toggleEquipmentFilter('${key}')">
          ${eq.icon}
          <span>${eq.name}</span>
        </div>
      `).join('');
    }

    function toggleEquipmentFilter(key) {
      const idx = state.equipmentFilter.indexOf(key);
      if (idx > -1) {
        state.equipmentFilter.splice(idx, 1);
      } else {
        state.equipmentFilter.push(key);
      }
      saveState();
      renderEquipmentFilterList();
      renderDailyTasks();
      renderZoneTasks();
    }

    function clearEquipmentFilter() {
      state.equipmentFilter = [];
      saveState();
      renderEquipmentFilterList();
      renderDailyTasks();
      renderZoneTasks();
    }

    function updateEnergyUI() {
      document.querySelectorAll('.energy-btn').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.energy) === state.energyLevel);
      });
    }

    function shouldShowTask(taskEffort, isCompleted, taskEquipment) {
      // Completed tasks always show
      if (isCompleted) return true;
      
      // Check energy level filter (always apply if set below max)
      const energyMatch = state.energyLevel >= 3 || taskEffort <= state.energyLevel;
      
      // Check equipment filter
      let equipmentMatch = true;
      if (state.equipmentFilter && state.equipmentFilter.length > 0) {
        // Task matches if it has no equipment OR has at least one of the selected equipment
        const taskEquip = taskEquipment || [];
        if (taskEquip.length === 0) {
          equipmentMatch = true; // Tasks with no equipment always match
        } else {
          equipmentMatch = state.equipmentFilter.some(eq => taskEquip.includes(eq));
        }
      }
      
      return energyMatch && equipmentMatch;
    }

    function renderEquipmentIcons(equipment) {
      if (!equipment || equipment.length === 0) return '';
      return `<div class="task-equipment">${equipment.map(e => 
        EQUIPMENT[e] ? `<div class="task-equipment-icon" title="${EQUIPMENT[e].name}">${EQUIPMENT[e].icon}</div>` : ''
      ).join('')}</div>`;
    }

    function renderTimeIcon(timeOfDay) {
      if (timeOfDay === 'morning') {
        return '<span class="time-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/></svg></span>';
      } else if (timeOfDay === 'evening') {
        return '<span class="time-icon"><svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></span>';
      }
      return '';
    }

    function setDailyTimeFilter(value) {
      state.dailyTimeFilter = value;
      saveState();
      renderDailyTasks();
    }

    function renderDailyTasks() {
      const c = document.getElementById('dailyTasks');
      const log = state.dailyLog[getTodayKey()] || { daily: {}, zone: {} };
      let vis = 0, done = 0;
      
      // Filter by time of day
      const timeFilter = state.dailyTimeFilter || 'all';
      const filteredTasks = state.dailyTasks.filter(t => {
        if (timeFilter === 'all') return true;
        if (timeFilter === 'morning') return t.timeOfDay === 'morning';
        if (timeFilter === 'evening') return t.timeOfDay === 'evening';
        if (timeFilter === 'anytime') return !t.timeOfDay;
        return true;
      });
      
      // Sort tasks: incomplete first, completed at bottom
      const sortedTasks = filteredTasks.map((t) => {
        const origIdx = state.dailyTasks.findIndex(orig => orig.id === t.id);
        return { ...t, originalIndex: origIdx };
      }).sort((a, b) => {
          const aComp = log.daily && log.daily[a.id] ? 1 : 0;
          const bComp = log.daily && log.daily[b.id] ? 1 : 0;
          return aComp - bComp;
        });
      
      c.innerHTML = sortedTasks.map(t => {
        const comp = log.daily && log.daily[t.id];
        const show = shouldShowTask(t.effort, comp, t.equipment);
        if (show) vis++;
        if (comp) done++;
        return `<div class="task-item ${comp ? 'completed' : ''} ${!show ? 'hidden' : ''}" onclick="openTaskFocus('daily', ${t.originalIndex})">
          <div class="task-checkbox" onclick="event.stopPropagation(); toggleDaily('${t.id}')">${renderTimeIcon(t.timeOfDay)}<svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="task-content">
            <div class="task-text">${t.text}</div>
            <div class="task-meta"><span class="effort-dot ${t.effort === 1 ? 'low' : t.effort === 2 ? 'med' : 'high'}"></span>${EFFORT_LABELS[t.effort]}</div>
          </div>
          ${renderEquipmentIcons(t.equipment)}
        </div>`;
      }).join('');
      document.getElementById('dailyCount').textContent = `${done}/${vis}`;
      
      // Update dropdown to match state
      const dropdown = document.getElementById('dailyTimeFilter');
      if (dropdown) dropdown.value = state.dailyTimeFilter || 'all';
    }

    function renderZoneTasks() {
      const c = document.getElementById('zoneTasks');
      const z = state.zones[state.currentZoneIndex];
      if (!state.zoneLog) state.zoneLog = {};
      let vis = 0, done = 0;
      
      // Sort tasks: incomplete first, completed at bottom
      const sortedTasks = z.tasks.map((t, idx) => ({ ...t, originalIndex: idx }))
        .sort((a, b) => {
          const aId = `z${state.currentZoneIndex}_${a.originalIndex}`;
          const bId = `z${state.currentZoneIndex}_${b.originalIndex}`;
          const aComp = state.zoneLog[aId] ? 1 : 0;
          const bComp = state.zoneLog[bId] ? 1 : 0;
          return aComp - bComp;
        });
      
      c.innerHTML = sortedTasks.map(t => {
        const id = `z${state.currentZoneIndex}_${t.originalIndex}`;
        const comp = state.zoneLog[id];
        const show = shouldShowTask(t.effort, comp, t.equipment);
        if (show) vis++;
        if (comp) done++;
        return `<div class="task-item ${comp ? 'completed' : ''} ${!show ? 'hidden' : ''}" onclick="openTaskFocus('zone', ${t.originalIndex})">
          <div class="task-checkbox" onclick="event.stopPropagation(); toggleZone('${id}')"><svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="task-content">
            <div class="task-text">${t.text}</div>
            <div class="task-meta"><span class="effort-dot ${t.effort === 1 ? 'low' : t.effort === 2 ? 'med' : 'high'}"></span>${EFFORT_LABELS[t.effort]}</div>
          </div>
          ${renderEquipmentIcons(t.equipment)}
        </div>`;
      }).join('');
      document.getElementById('zoneCount').textContent = `${done}/${vis}`;
    }

    function toggleDaily(id) {
      const k = getTodayKey();
      if (!state.dailyLog[k]) state.dailyLog[k] = { daily: {}, zone: {} };
      const wasCompleted = state.dailyLog[k].daily[id];
      state.dailyLog[k].daily[id] = !state.dailyLog[k].daily[id];
      recordActivity(); saveState(); renderDailyTasks(); updateProgress();
      
      // Show confetti when completing a task (not uncompleting)
      if (!wasCompleted) {
        showConfetti();
      }
    }

    function toggleZone(id) {
      if (!state.zoneLog) state.zoneLog = {};
      const wasCompleted = state.zoneLog[id];
      state.zoneLog[id] = !state.zoneLog[id];
      recordActivity(); saveState(); renderZoneTasks(); updateProgress();
      
      // Show confetti when completing a task (not uncompleting)
      if (!wasCompleted) {
        showConfetti();
      }
    }

    function recordActivity() {
      const today = getTodayKey();
      if (state.lastActiveDate !== today) {
        state.streak++; state.lastActiveDate = today;
        addPlantToGarden();
        updateStreak(); showToast(`Streak: ${state.streak} day${state.streak > 1 ? 's' : ''} üå±`);
      }
    }

    function updateProgress() {
      const log = state.dailyLog[getTodayKey()] || { daily: {}, zone: {} };
      const z = state.zones[state.currentZoneIndex];
      const dc = Object.values(log.daily || {}).filter(Boolean).length;
      const zc = Object.values(log.zone || {}).filter(Boolean).length;
      const total = state.dailyTasks.length + z.tasks.length;
      const pct = total > 0 ? Math.round(((dc + zc) / total) * 100) : 0;
      document.getElementById('zoneProgress').style.width = `${pct}%`;
      document.getElementById('zoneProgressText').textContent = `${pct}%`;
    }

    function updateStreak() {
      document.getElementById('gardenStreak').textContent = `${state.streak || 0} day${state.streak !== 1 ? 's' : ''}`;
      renderGarden();
    }

    function renderGarden() {
      const container = document.getElementById('gardenContainer');
      const waterMsg = document.getElementById('gardenWater');
      
      if (!state.garden) state.garden = [];
      
      // Check if garden needs water (missed a day)
      if (state.gardenNeedsWater) {
        waterMsg.style.display = 'flex';
        // Show wilted plants
        if (state.garden.length > 0) {
          container.innerHTML = state.garden.map((plantIdx, i) => {
            const plant = GARDEN_PLANTS[plantIdx % GARDEN_PLANTS.length];
            return `<div class="garden-plant wilted" title="${plant.name}">${plant.icon}</div>`;
          }).join('');
        } else {
          container.innerHTML = '<div class="garden-empty">Your garden needs water to grow!</div>';
        }
        return;
      }
      
      waterMsg.style.display = 'none';
      
      if (state.garden.length === 0) {
        container.innerHTML = '<div class="garden-empty">Complete tasks to grow your garden!</div>';
        return;
      }
      
      container.innerHTML = state.garden.map((plantIdx, i) => {
        const plant = GARDEN_PLANTS[plantIdx % GARDEN_PLANTS.length];
        return `<div class="garden-plant" title="${plant.name}">${plant.icon}</div>`;
      }).join('');
    }

    function addPlantToGarden() {
      if (!state.garden) state.garden = [];
      // Add a plant based on current streak
      const plantIdx = state.garden.length % GARDEN_PLANTS.length;
      state.garden.push(plantIdx);
      // Limit garden size to prevent overflow
      if (state.garden.length > 30) {
        state.garden = state.garden.slice(-30);
      }
      saveState();
      renderGarden();
    }

    function waterGarden() {
      state.gardenNeedsWater = false;
      // Don't add a plant, just revive the existing ones
      saveState();
      renderGarden();
      showToast('Garden watered! üíßüå±');
    }

    // Timer
    function renderTimer() { updateTimerDisplay(); }

    function updateTimerDisplay() {
      const m = Math.floor(state.timerSeconds / 60);
      const s = state.timerSeconds % 60;
      const display = `${m}:${s.toString().padStart(2, '0')}`;
      document.getElementById('timerDisplay').textContent = display;
      document.getElementById('focusTimerDisplay').textContent = display;
      const total = state.timerMinutes * 60;
      const prog = ((total - state.timerSeconds) / total) * 226.19;
      document.getElementById('timerProgress').style.strokeDashoffset = 226.19 - prog;
      const focusProg = ((total - state.timerSeconds) / total) * 565.48;
      document.getElementById('focusTimerProgress').style.strokeDashoffset = 565.48 - focusProg;
      const status = state.timerRunning ? "Time to tidy!" : state.timerSeconds === 0 ? "Great job! üéâ" : state.timerSeconds < total ? "Paused" : "Ready to start";
      document.getElementById('timerStatus').textContent = status;
    }

    function toggleTimer() {
      if (state.timerRunning) pauseTimer(); else startTimer();
    }

    function startTimer() {
      if (state.timerSeconds === 0) state.timerSeconds = state.timerMinutes * 60;
      state.timerRunning = true;
      document.getElementById('playIcon').style.display = 'none';
      document.getElementById('pauseIcon').style.display = 'block';
      state.timerInterval = setInterval(() => {
        state.timerSeconds--;
        updateTimerDisplay();
        // Check for chime
        if (state.chimeEnabled && state.timerSeconds > 0) {
          const elapsed = (state.timerMinutes * 60) - state.timerSeconds;
          if (elapsed > 0 && elapsed % (state.chimeInterval * 60) === 0) {
            playChime(state.chimeSound);
          }
        }
        if (state.timerSeconds <= 0) timerDone();
      }, 1000);
    }

    function pauseTimer() {
      state.timerRunning = false;
      clearInterval(state.timerInterval);
      document.getElementById('playIcon').style.display = 'block';
      document.getElementById('pauseIcon').style.display = 'none';
      updateTimerDisplay();
    }

    function resetTimer() {
      pauseTimer();
      state.timerSeconds = state.timerMinutes * 60;
      updateTimerDisplay();
    }

    function timerDone() {
      pauseTimer(); state.timerSeconds = 0; updateTimerDisplay();
      showToast("Time's up! Amazing work! üéâ");
      showConfetti();
      if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
    }

    function setTimerPreset(min) {
      state.timerMinutes = min;
      state.timerSeconds = min * 60;
      document.querySelectorAll('.timer-preset').forEach(b => b.classList.toggle('active', parseInt(b.dataset.minutes) === min));
      updateTimerDisplay(); saveState();
    }

    // Focus Mode
    function openTaskFocus(type, index) {
      const log = state.dailyLog[getTodayKey()] || { daily: {} };
      if (!state.zoneLog) state.zoneLog = {};
      const z = state.zones[state.currentZoneIndex];
      state.focusTasks = [];
      
      // Build list starting from the tapped task, then continue with remaining tasks in order
      // First, gather all uncompleted tasks in order
      let allTasks = [];
      
      state.dailyTasks.forEach((t, idx) => {
        const comp = log.daily && log.daily[t.id];
        if (!comp && shouldShowTask(t.effort, false, t.equipment)) {
          allTasks.push({ type: 'daily', id: t.id, text: t.text, effort: t.effort, equipment: t.equipment || [], originalIndex: idx });
        }
      });
      
      z.tasks.forEach((t, idx) => {
        const id = `z${state.currentZoneIndex}_${idx}`;
        const comp = state.zoneLog[id];
        if (!comp && shouldShowTask(t.effort, false, t.equipment)) {
          allTasks.push({ type: 'zone', id, text: t.text, effort: t.effort, equipment: t.equipment || [], originalIndex: idx });
        }
      });
      
      // Find the index of the tapped task in our allTasks array
      let tappedTaskIndex = allTasks.findIndex(t => {
        if (type === 'daily') {
          return t.type === 'daily' && t.originalIndex === index;
        } else {
          return t.type === 'zone' && t.originalIndex === index;
        }
      });
      
      if (tappedTaskIndex === -1) return; // Task already completed
      
      // Reorder: tapped task first, then tasks after it, then tasks before it
      state.focusTasks = [
        ...allTasks.slice(tappedTaskIndex),
        ...allTasks.slice(0, tappedTaskIndex)
      ];
      
      state.focusIndex = 0;
      document.getElementById('focusOverlay').classList.add('active');
      document.getElementById('focusActiveContent').style.display = 'block';
      document.getElementById('focusCompleteMsg').classList.remove('show');
      updateFocusTask();
      updateFocusChimeToggle();
      
      if (!state.timerRunning) {
        if (state.timerSeconds === 0) state.timerSeconds = state.timerMinutes * 60;
        startTimer();
      }
    }

    function enterFocusMode() {
      const log = state.dailyLog[getTodayKey()] || { daily: {} };
      if (!state.zoneLog) state.zoneLog = {};
      const z = state.zones[state.currentZoneIndex];
      state.focusTasks = [];
      
      // Gather uncompleted tasks that pass the current filter
      state.dailyTasks.forEach(t => {
        const comp = log.daily && log.daily[t.id];
        if (!comp && shouldShowTask(t.effort, false, t.equipment)) {
          state.focusTasks.push({ type: 'daily', id: t.id, text: t.text, effort: t.effort, equipment: t.equipment || [] });
        }
      });
      z.tasks.forEach((t, i) => {
        const id = `z${state.currentZoneIndex}_${i}`;
        const comp = state.zoneLog[id];
        if (!comp && shouldShowTask(t.effort, false, t.equipment)) {
          state.focusTasks.push({ type: 'zone', id, text: t.text, effort: t.effort, equipment: t.equipment || [] });
        }
      });
      
      // Shuffle the tasks for random order
      for (let i = state.focusTasks.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [state.focusTasks[i], state.focusTasks[j]] = [state.focusTasks[j], state.focusTasks[i]];
      }
      
      state.focusIndex = 0;
      document.getElementById('focusOverlay').classList.add('active');
      document.getElementById('focusActiveContent').style.display = 'block';
      document.getElementById('focusCompleteMsg').classList.remove('show');
      updateFocusTask();
      updateFocusChimeToggle();
      
      // Start timer if not already running
      if (!state.timerRunning) {
        if (state.timerSeconds === 0) state.timerSeconds = state.timerMinutes * 60;
        startTimer();
      }
    }

    function updateFocusTask() {
      if (state.focusIndex >= state.focusTasks.length) {
        document.getElementById('focusActiveContent').style.display = 'none';
        document.getElementById('focusCompleteMsg').classList.add('show');
        return;
      }
      const task = state.focusTasks[state.focusIndex];
      document.getElementById('focusTaskText').textContent = task.text;
      
      // Show equipment with names
      const equipContainer = document.getElementById('focusEquipment');
      if (task.equipment && task.equipment.length > 0) {
        equipContainer.innerHTML = task.equipment
          .filter(e => EQUIPMENT[e])
          .map(e => `<div class="focus-equipment-item">${EQUIPMENT[e].icon}<span>${EQUIPMENT[e].name}</span></div>`)
          .join('');
      } else {
        equipContainer.innerHTML = '';
      }
    }

    function completeFocusTask() {
      if (state.focusIndex >= state.focusTasks.length) return;
      const t = state.focusTasks[state.focusIndex];
      if (t.type === 'daily') toggleDaily(t.id);
      else toggleZone(t.id);
      // Move to next task
      state.focusIndex++;
      if (state.focusIndex >= state.focusTasks.length) {
        // Reached end, show completion
        document.getElementById('focusActiveContent').style.display = 'none';
        document.getElementById('focusCompleteMsg').classList.add('show');
      } else {
        updateFocusTask();
      }
    }

    function skipFocusTask() {
      // Move to next task without removing current one
      state.focusIndex++;
      if (state.focusIndex >= state.focusTasks.length) {
        // Reached end, show completion
        document.getElementById('focusActiveContent').style.display = 'none';
        document.getElementById('focusCompleteMsg').classList.add('show');
      } else {
        updateFocusTask();
      }
    }

    function exitFocusMode() {
      document.getElementById('focusOverlay').classList.remove('active');
      if (state.timerRunning) {
        pauseTimer();
      }
      renderAll();
    }

    // Modals
    function openSettings() {
      renderZoneListSettings();
      renderEquipmentManager();
      renderChimeSettings();
      document.querySelectorAll('.timer-preset').forEach(b => b.classList.toggle('active', parseInt(b.dataset.minutes) === state.timerMinutes));
      document.getElementById('settingsModal').classList.add('active');
    }

    function renderChimeSettings() {
      // Toggle
      document.getElementById('chimeToggle').checked = state.chimeEnabled;
      
      // Show/hide options
      const options = document.getElementById('chimeOptions');
      options.classList.toggle('hidden', !state.chimeEnabled);
      
      // Sound options
      const soundContainer = document.getElementById('chimeSoundOptions');
      soundContainer.innerHTML = Object.entries(CHIME_SOUNDS).map(([key, sound]) => `
        <button class="chime-sound-btn ${state.chimeSound === key ? 'active' : ''}" 
                onclick="setChimeSound('${key}')">${sound.name}</button>
      `).join('');
      
      // Interval options
      document.querySelectorAll('.chime-interval-btn').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.interval) === state.chimeInterval);
      });
    }

    function toggleChime(enabled) {
      state.chimeEnabled = enabled;
      saveState();
      renderChimeSettings();
    }

    function setChimeSound(soundKey) {
      state.chimeSound = soundKey;
      saveState();
      renderChimeSettings();
      // Play preview
      playChime(soundKey);
    }

    function setChimeInterval(minutes) {
      state.chimeInterval = minutes;
      saveState();
      renderChimeSettings();
    }

    function toggleFocusChime() {
      state.chimeEnabled = !state.chimeEnabled;
      saveState();
      updateFocusChimeToggle();
    }

    function updateFocusChimeToggle() {
      const btn = document.getElementById('focusChimeToggle');
      if (btn) {
        btn.classList.toggle('muted', !state.chimeEnabled);
        btn.title = state.chimeEnabled ? 'Sound on - tap to mute' : 'Sound off - tap to unmute';
      }
    }

    function renderEquipmentManager() {
      const container = document.getElementById('equipmentManager');
      container.innerHTML = Object.entries(EQUIPMENT).map(([key, eq]) => {
        const enabled = state.enabledEquipment.includes(key);
        return `<div class="equipment-manager-item ${enabled ? '' : 'disabled'}" onclick="toggleEquipmentEnabled('${key}')">
          ${eq.icon}
          <span>${eq.name}</span>
        </div>`;
      }).join('');
    }

    function toggleEquipmentEnabled(key) {
      const idx = state.enabledEquipment.indexOf(key);
      if (idx > -1) {
        state.enabledEquipment.splice(idx, 1);
      } else {
        state.enabledEquipment.push(key);
      }
      saveState();
      renderEquipmentManager();
    }

    function renderZoneListSettings() {
      document.getElementById('zoneListSettings').innerHTML = state.zones.map((z, i) =>
        `<div class="zone-item ${i === state.currentZoneIndex ? 'current' : ''}" onclick="jumpToZone(${i})">
          <div class="zone-number">${i + 1}</div>
          <div class="zone-item-name">${z.name}</div>
          ${i === state.currentZoneIndex ? '<span class="zone-item-badge">Current</span>' : ''}
        </div>`
      ).join('');
    }

    function jumpToZone(i) {
      state.currentZoneIndex = i; saveState();
      closeModal('settingsModal'); renderAll();
      showToast(`Switched to ${state.zones[i].name}`);
    }

    function openWeeklyReview() {
      const z = state.zones[state.currentZoneIndex];
      document.getElementById('reviewZoneName').textContent = z.name;
      if (!state.zoneLog) state.zoneLog = {};
      
      let done = [], skip = [];
      z.tasks.forEach((t, idx) => {
        const id = `z${state.currentZoneIndex}_${idx}`;
        if (state.zoneLog[id]) {
          done.push(t.text);
        } else {
          skip.push(t.text);
        }
      });
      
      document.getElementById('reviewCompleted').textContent = done.length;
      document.getElementById('reviewSkipped').textContent = skip.length;
      document.getElementById('reviewCompletedList').innerHTML = done.length ? done.map(t => `<div class="review-task"><svg class="review-task-icon done" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>${t}</div>`).join('') : '<div class="day-detail-empty">No tasks completed yet</div>';
      document.getElementById('reviewSkippedList').innerHTML = skip.length ? skip.map(t => `<div class="review-task"><svg class="review-task-icon skipped" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>${t}</div>`).join('') : '<div class="day-detail-empty">All done! üéâ</div>';
      document.getElementById('reviewModal').classList.add('active');
    }

    function moveToNextZone() {
      state.zoneLog = {}; // Clear zone task completions
      state.currentZoneIndex = (state.currentZoneIndex + 1) % state.zones.length;
      state.weekStartDate = getWeekStart();
      state.weekChangePending = false;
      saveState(); closeModal('reviewModal'); renderAll();
      showToast(`Now on: ${state.zones[state.currentZoneIndex].name}`);
    }

    function openHistory() {
      state.calendarMonth = new Date().getMonth();
      state.calendarYear = new Date().getFullYear();
      state.selectedDate = null;
      renderCalendar();
      document.getElementById('historyModal').classList.add('active');
    }

    function renderCalendar() {
      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const first = new Date(state.calendarYear, state.calendarMonth, 1);
      const last = new Date(state.calendarYear, state.calendarMonth + 1, 0);
      const startDay = first.getDay();
      const daysInMonth = last.getDate();
      let html = `<div class="calendar-header">
        <div class="calendar-title">${months[state.calendarMonth]} ${state.calendarYear}</div>
        <div class="calendar-nav">
          <button class="calendar-nav-btn" onclick="prevMonth()"><svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg></button>
          <button class="calendar-nav-btn" onclick="nextMonth()"><svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"/></svg></button>
        </div>
      </div>
      <div class="calendar-weekdays">
        <div class="calendar-weekday">Sun</div><div class="calendar-weekday">Mon</div><div class="calendar-weekday">Tue</div>
        <div class="calendar-weekday">Wed</div><div class="calendar-weekday">Thu</div><div class="calendar-weekday">Fri</div><div class="calendar-weekday">Sat</div>
      </div>
      <div class="calendar-days">`;
      const today = getTodayKey();
      for (let i = 0; i < startDay; i++) html += `<div class="calendar-day other-month"></div>`;
      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${state.calendarYear}-${String(state.calendarMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const hasAct = state.dailyLog[dateStr] && (Object.values(state.dailyLog[dateStr].daily || {}).some(Boolean) || Object.values(state.dailyLog[dateStr].zone || {}).some(Boolean));
        const isToday = dateStr === today;
        const isSel = dateStr === state.selectedDate;
        html += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasAct ? 'has-activity' : ''} ${isSel ? 'selected' : ''}" onclick="selectDate('${dateStr}')">${d}</div>`;
      }
      html += `</div>`;
      if (state.selectedDate) {
        const log = state.dailyLog[state.selectedDate] || { daily: {}, zone: {} };
        const tasks = [];
        state.dailyTasks.forEach(t => { if (log.daily && log.daily[t.id]) tasks.push(t.text); });
        state.zones.forEach((z, zi) => {
          z.tasks.forEach((t, ti) => { if (log.zone && log.zone[`z${zi}_${ti}`]) tasks.push(`${z.name}: ${t.text}`); });
        });
        html += `<div class="day-detail"><div class="day-detail-title">${state.selectedDate}</div>`;
        html += tasks.length ? tasks.map(t => `<div class="review-task"><svg class="review-task-icon done" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>${t}</div>`).join('') : '<div class="day-detail-empty">No tasks completed</div>';
        html += '</div>';
      }
      document.getElementById('calendar').innerHTML = html;
    }

    function prevMonth() {
      state.calendarMonth--;
      if (state.calendarMonth < 0) { state.calendarMonth = 11; state.calendarYear--; }
      state.selectedDate = null; renderCalendar();
    }

    function nextMonth() {
      state.calendarMonth++;
      if (state.calendarMonth > 11) { state.calendarMonth = 0; state.calendarYear++; }
      state.selectedDate = null; renderCalendar();
    }

    function selectDate(d) { state.selectedDate = d; renderCalendar(); }

    // Task editors
    function openDailyEditor() {
      renderDailyEditorList();
      document.getElementById('dailyEditorModal').classList.add('active');
    }

    function renderEquipmentSelector(selectedEquipment, taskIndex, type) {
      const selected = selectedEquipment || [];
      const enabledItems = Object.entries(EQUIPMENT).filter(([key]) => state.enabledEquipment.includes(key));
      if (enabledItems.length === 0) return '';
      return `<div class="equipment-selector" data-task="${taskIndex}" data-type="${type}">
        ${enabledItems.map(([key, eq]) => `
          <button type="button" class="equipment-toggle ${selected.includes(key) ? 'selected' : ''}" 
                  data-equipment="${key}" 
                  title="${eq.name}"
                  onclick="toggleEquipment('${type}', ${taskIndex}, '${key}')">
            ${eq.icon}
          </button>
        `).join('')}
      </div>`;
    }

    function toggleEquipment(type, taskIndex, equipmentKey) {
      let task;
      if (type === 'daily') {
        task = state.dailyTasks[taskIndex];
      } else {
        task = state.zones[state.currentZoneIndex].tasks[taskIndex];
      }
      
      if (!task.equipment) task.equipment = [];
      
      const idx = task.equipment.indexOf(equipmentKey);
      if (idx > -1) {
        task.equipment.splice(idx, 1);
      } else {
        task.equipment.push(equipmentKey);
      }
      
      // Update button state
      const btn = document.querySelector(`.equipment-selector[data-task="${taskIndex}"][data-type="${type}"] .equipment-toggle[data-equipment="${equipmentKey}"]`);
      if (btn) btn.classList.toggle('selected', idx === -1);
    }

    function renderDailyEditorList() {
      document.getElementById('dailyEditorList').innerHTML = state.dailyTasks.map((t, i) => `
        <div class="edit-task-item" style="flex-direction: column; align-items: stretch;" draggable="true" data-index="${i}" ondragstart="dragTaskStart(event, 'daily')" ondragover="dragTaskOver(event)" ondrop="dropTask(event, 'daily')" ondragend="dragTaskEnd(event)">
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="edit-task-drag">
              <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
            </div>
            <input type="text" class="edit-task-input" value="${t.text}" data-index="${i}" onchange="updateDailyTaskText(${i}, this.value)" onblur="updateDailyTaskText(${i}, this.value)">
            <select class="effort-select" data-index="${i}" onchange="updateDailyTaskEffort(${i}, this.value)">
              <option value="1" ${t.effort === 1 ? 'selected' : ''}>Low</option>
              <option value="2" ${t.effort === 2 ? 'selected' : ''}>Medium</option>
              <option value="3" ${t.effort === 3 ? 'selected' : ''}>High</option>
            </select>
            <button class="delete-task-btn" onclick="deleteDailyTask(${i})"><svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; margin-left: 24px;">
            <span style="font-size: 0.75rem; color: var(--warm-gray);">Time:</span>
            <div class="time-selector">
              <button type="button" class="time-btn ${!t.timeOfDay ? 'selected' : ''}" onclick="setDailyTaskTime(${i}, null)" title="Any time">‚Äî</button>
              <button type="button" class="time-btn ${t.timeOfDay === 'morning' ? 'selected' : ''}" onclick="setDailyTaskTime(${i}, 'morning')" title="Morning">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/></svg>
              </button>
              <button type="button" class="time-btn ${t.timeOfDay === 'evening' ? 'selected' : ''}" onclick="setDailyTaskTime(${i}, 'evening')" title="Evening">
                <svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
              </button>
            </div>
          </div>
          ${renderEquipmentSelector(t.equipment, i, 'daily')}
        </div>
      `).join('');
    }

    function setDailyTaskTime(index, time) {
      state.dailyTasks[index].timeOfDay = time;
      saveState();
      renderDailyEditorList();
    }

    let draggedTaskIndex = null;
    let draggedTaskType = null;

    function dragTaskStart(e, type) {
      draggedTaskIndex = parseInt(e.target.closest('.edit-task-item').dataset.index);
      draggedTaskType = type;
      e.target.closest('.edit-task-item').classList.add('dragging');
    }

    function dragTaskOver(e) {
      e.preventDefault();
    }

    function dropTask(e, type) {
      e.preventDefault();
      const targetItem = e.target.closest('.edit-task-item');
      if (!targetItem) return;
      
      const targetIndex = parseInt(targetItem.dataset.index);
      if (draggedTaskIndex !== null && draggedTaskIndex !== targetIndex && draggedTaskType === type) {
        if (type === 'daily') {
          const [removed] = state.dailyTasks.splice(draggedTaskIndex, 1);
          state.dailyTasks.splice(targetIndex, 0, removed);
          saveState();
          renderDailyEditorList();
        } else if (type === 'zone') {
          const z = state.zones[state.currentZoneIndex];
          const [removed] = z.tasks.splice(draggedTaskIndex, 1);
          z.tasks.splice(targetIndex, 0, removed);
          saveState();
          renderZoneEditorList();
        }
      }
    }

    function dragTaskEnd(e) {
      document.querySelectorAll('.edit-task-item').forEach(el => el.classList.remove('dragging'));
      draggedTaskIndex = null;
      draggedTaskType = null;
    }

    function updateDailyTaskText(index, value) {
      state.dailyTasks[index].text = value;
      saveState();
    }

    function updateDailyTaskEffort(index, value) {
      state.dailyTasks[index].effort = parseInt(value);
      saveState();
    }

    function addDailyTask() {
      state.dailyTasks.push({ id: 'd' + Date.now(), text: '', effort: 1, equipment: [], timeOfDay: null });
      saveState();
      renderDailyEditorList();
      // Focus the new input
      setTimeout(() => {
        const inputs = document.querySelectorAll('#dailyEditorList .edit-task-input');
        if (inputs.length) inputs[inputs.length - 1].focus();
      }, 50);
    }

    function deleteDailyTask(i) { 
      state.dailyTasks.splice(i, 1); 
      saveState();
      renderDailyEditorList(); 
    }

    function saveDailyEdits() {
      saveState();
      closeModal('dailyEditorModal'); 
      renderDailyTasks();
      showToast('Daily tasks updated!');
    }

    function openZoneEditor() {
      const z = state.zones[state.currentZoneIndex];
      document.getElementById('zoneEditorTitle').textContent = `Edit ${z.name}`;
      document.getElementById('zoneNameInput').value = z.name;
      renderZoneIconSelector(z.icon || 'living');
      renderZoneEditorList();
      document.getElementById('zoneEditorModal').classList.add('active');
    }

    function renderZoneIconSelector(selectedIcon) {
      const container = document.getElementById('zoneIconSelector');
      container.innerHTML = Object.entries(ZONE_ICONS).map(([key, data]) => `
        <button type="button" class="zone-icon-btn ${selectedIcon === key ? 'selected' : ''}" 
                onclick="selectZoneIcon('${key}')" title="${data.name}">
          ${data.icon}
        </button>
      `).join('');
    }

    function selectZoneIcon(iconKey) {
      state.zones[state.currentZoneIndex].icon = iconKey;
      saveState();
      renderZoneIconSelector(iconKey);
    }

    function renderZoneEditorList() {
      const z = state.zones[state.currentZoneIndex];
      document.getElementById('zoneEditorList').innerHTML = z.tasks.map((t, i) => `
        <div class="edit-task-item" style="flex-direction: column; align-items: stretch;" draggable="true" data-index="${i}" ondragstart="dragTaskStart(event, 'zone')" ondragover="dragTaskOver(event)" ondrop="dropTask(event, 'zone')" ondragend="dragTaskEnd(event)">
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="edit-task-drag">
              <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
            </div>
            <input type="text" class="edit-task-input" value="${t.text}" data-index="${i}" onchange="updateZoneTaskText(${i}, this.value)" onblur="updateZoneTaskText(${i}, this.value)">
            <select class="effort-select" data-index="${i}" onchange="updateZoneTaskEffort(${i}, this.value)">
              <option value="1" ${t.effort === 1 ? 'selected' : ''}>Low</option>
              <option value="2" ${t.effort === 2 ? 'selected' : ''}>Medium</option>
              <option value="3" ${t.effort === 3 ? 'selected' : ''}>High</option>
            </select>
            <button class="delete-task-btn" onclick="deleteZoneTask(${i})"><svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
          </div>
          ${renderEquipmentSelector(t.equipment, i, 'zone')}
        </div>
      `).join('');
    }

    function updateZoneTaskText(index, value) {
      state.zones[state.currentZoneIndex].tasks[index].text = value;
      saveState();
    }

    function updateZoneTaskEffort(index, value) {
      state.zones[state.currentZoneIndex].tasks[index].effort = parseInt(value);
      saveState();
    }

    function addZoneTask() {
      state.zones[state.currentZoneIndex].tasks.push({ text: '', effort: 1, equipment: [] });
      saveState();
      renderZoneEditorList();
      // Focus the new input
      setTimeout(() => {
        const inputs = document.querySelectorAll('#zoneEditorList .edit-task-input');
        if (inputs.length) inputs[inputs.length - 1].focus();
      }, 50);
    }

    function deleteZoneTask(i) { 
      state.zones[state.currentZoneIndex].tasks.splice(i, 1); 
      saveState();
      renderZoneEditorList(); 
    }

    function saveZoneEdits() {
      const z = state.zones[state.currentZoneIndex];
      z.name = document.getElementById('zoneNameInput').value;
      saveState(); 
      closeModal('zoneEditorModal'); 
      renderAll();
      showToast('Zone updated!');
    }

    // Zones Manager
    function openZonesManager() {
      renderZonesManagerList();
      document.getElementById('zonesManagerModal').classList.add('active');
    }

    function renderZonesManagerList() {
      const container = document.getElementById('zonesManagerList');
      container.innerHTML = state.zones.map((z, i) => {
        const iconData = ZONE_ICONS[z.icon] || ZONE_ICONS.living;
        return `
        <div class="zone-item ${i === state.currentZoneIndex ? 'current' : ''}" 
             draggable="true" 
             data-index="${i}"
             ondragstart="dragStart(event)" 
             ondragover="dragOver(event)" 
             ondrop="drop(event)"
             ondragend="dragEnd(event)">
          <div class="zone-item-drag">
            <svg class="icon" viewBox="0 0 24 24" style="width:18px;height:18px;"><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
          </div>
          <div class="zone-item-icon">${iconData.icon}</div>
          <div class="zone-item-name" onclick="editZoneFromManager(${i})">${z.name}</div>
          ${i === state.currentZoneIndex ? '<span class="zone-item-badge">Current</span>' : ''}
          <button class="delete-task-btn" onclick="event.stopPropagation(); deleteZone(${i})" ${state.zones.length <= 1 ? 'disabled style="opacity:0.3"' : ''}>
            <svg class="icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>`;
      }).join('');
    }

    let draggedIndex = null;

    function dragStart(e) {
      draggedIndex = parseInt(e.target.closest('.zone-item').dataset.index);
      e.target.closest('.zone-item').classList.add('dragging');
    }

    function dragOver(e) {
      e.preventDefault();
    }

    function drop(e) {
      e.preventDefault();
      const targetIndex = parseInt(e.target.closest('.zone-item').dataset.index);
      if (draggedIndex !== null && draggedIndex !== targetIndex) {
        const [removed] = state.zones.splice(draggedIndex, 1);
        state.zones.splice(targetIndex, 0, removed);
        // Adjust currentZoneIndex if needed
        if (state.currentZoneIndex === draggedIndex) {
          state.currentZoneIndex = targetIndex;
        } else if (draggedIndex < state.currentZoneIndex && targetIndex >= state.currentZoneIndex) {
          state.currentZoneIndex--;
        } else if (draggedIndex > state.currentZoneIndex && targetIndex <= state.currentZoneIndex) {
          state.currentZoneIndex++;
        }
        saveState();
        renderZonesManagerList();
        renderAll();
      }
    }

    function dragEnd(e) {
      document.querySelectorAll('.zone-item').forEach(el => el.classList.remove('dragging'));
      draggedIndex = null;
    }

    function editZoneFromManager(index) {
      state.currentZoneIndex = index;
      saveState();
      closeModal('zonesManagerModal');
      openZoneEditor();
    }

    function addNewZone() {
      state.zones.push({
        id: Date.now(),
        name: 'New Zone',
        icon: 'living',
        tasks: [{ text: '', effort: 1, equipment: [] }]
      });
      saveState();
      renderZonesManagerList();
      showToast('New zone added!');
    }

    let zoneToDelete = null;

    function deleteZone(index) {
      if (state.zones.length <= 1) return;
      zoneToDelete = index;
      document.getElementById('deleteZoneName').textContent = state.zones[index].name;
      document.getElementById('deleteZoneConfirmModal').classList.add('active');
    }

    function confirmDeleteZone() {
      if (zoneToDelete !== null) {
        state.zones.splice(zoneToDelete, 1);
        if (state.currentZoneIndex >= state.zones.length) {
          state.currentZoneIndex = state.zones.length - 1;
        }
        saveState();
        zoneToDelete = null;
        closeModal('deleteZoneConfirmModal');
        renderZonesManagerList();
        renderAll();
        showToast('Zone deleted');
      }
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function resetAllData() {
      closeModal('settingsModal');
      document.getElementById('resetConfirmModal').classList.add('active');
    }

    function confirmReset() {
      localStorage.removeItem('miseEnPlaceState');
      location.reload();
    }

    function exportData() {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mise-en-place-backup-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Data exported!');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          // Validate it has expected properties
          if (imported.zones && imported.dailyTasks) {
            state = { ...state, ...imported };
            state.timerSeconds = state.timerMinutes * 60;
            state.timerRunning = false;
            saveState();
            renderAll();
            showToast('Data imported successfully!');
            closeModal('settingsModal');
          } else {
            showToast('Invalid file format');
          }
        } catch (err) {
          showToast('Error reading file');
        }
      };
      reader.readAsText(file);
      event.target.value = ''; // Reset input
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function showConfetti() {
      const container = document.createElement('div');
      container.className = 'confetti-container';
      document.body.appendChild(container);
      
      const colors = ['#52665c', '#7a9185', '#a3b5ab', '#c9d3ce', '#f0e6a3', '#c9dbe8'];
      
      for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.8 + 's';
        confetti.style.animationDuration = (3 + Math.random() * 2) + 's';
        container.appendChild(confetti);
      }
      
      setTimeout(() => container.remove(), 6000);
    }

    document.querySelectorAll('.modal-overlay').forEach(m => {
      m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
    });

    init();
  </script>
</body>
</html>
